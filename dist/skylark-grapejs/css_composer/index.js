/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-underscore","./config/config","./model/CssRule","./model/CssRules","./view/CssRulesView","../selector_manager/model/Selectors","../selector_manager/model/Selector"],function(e,t,s,r,a,n,l){"use strict";return()=>{let o;var d,i,g={};return{Selectors:n,name:"CssComposer",getConfig:()=>g,storageKey(){var e=[],t=g.stm&&g.stm.getConfig()||{};return t.storeCss&&e.push("css"),t.storeStyles&&e.push("styles"),e},init(e){for(var s in g=e||{},t)s in g||(g[s]=t[s]);var n=g.pStylePrefix;n&&(g.stylePrefix=n+g.stylePrefix);var l=g.em&&g.em.config.style||"";return g.rules=l||g.rules,o=g.em,d=new r([],g),i=new a({collection:d,config:g}),this},onLoad(){d.add(g.rules)},postLoad(e){const t="add remove",s=this.getAll(),r=e.get("UndoManager");r&&r.add(s),e.stopListening(s,t,this.handleChange),e.listenTo(s,t,this.handleChange),s.each(e=>this.handleChange(e,{avoidStore:1}))},handleChange(e,t={}){const s="change:style",r=o.get("UndoManager");r&&r.add(e);const a=o.handleUpdates.bind(o);o.stopListening(e,s,a),o.listenTo(e,s,a),!t.avoidStore&&a("","",t)},load(t){var s=t||"";!s&&g.stm&&(s=g.em.getCacheLoad());var r=s.styles||"";if(s.styles)try{r=JSON.parse(s.styles)}catch(e){}else s.css&&(r=g.em.get("Parser").parseCss(s.css));return e.isArray(r)?r.length&&d.reset(r):r&&d.reset(r),r},store(e){if(g.stm){var t={},s=this.storageKey();return s.indexOf("css")>=0&&(t.css=g.em.getCss()),s.indexOf("styles")>=0&&(t.styles=JSON.stringify(d)),e||g.stm.store(t),t}},add(e,t,r,a={}){var n=t||"",l=r||"",o={...a},i=this.get(e,n,l,o);return i&&i.config&&!i.config.singleAtRule?i:(o.state=n,o.mediaText=l,o.selectors="",(i=new s(o,g)).get("selectors").add(e),d.add(i),i)},get(e,t,s,r){var a=null;return d.each(n=>{a||n.compare(e,t,s,r)&&(a=n)}),a},getAll:()=>d,clear(){return this.getAll().reset(),this},addCollection(e,t={}){for(var s=[],r=e instanceof Array?e:[e],a=0,n=r.length;a<n;a++){var l=r[a]||{};if(!l.selectors)continue;var o=g.em&&g.em.get("SelectorManager");o||console.warn("Selector Manager not found");for(var d=l.selectors,i=d instanceof Array?d:[d],c=[],u=0,h=i.length;u<h;u++){var m=o.add(i[u]);c.push(m)}var y=this.get(c,l.state,l.mediaText,l),f=this.add(c,l.state,l.mediaText,l),C=!y||!t.avoidUpdateStyle;const e=l.style||{};if(C){let s=t.extend?{...f.get("style"),...e}:e;f.set("style",s)}s.push(f)}return s},setRule(e,t,s={}){const{atRuleType:r,atRuleParams:a}=s,n=o.get("Parser").parserCss.checkNode({selectors:e,style:t})[0],{state:l,selectorsAdd:d}=n,i=o.get("SelectorManager").add(n.selectors),g=this.add(i,l,a,{selectorsAdd:d,atRule:r});return g.setStyle(t,s),g},getRule(e,t={}){const s=o.get("SelectorManager"),r=o.get("Parser").parserCss.checkNode({selectors:e})[0],a=s.get(r.selectors),{state:n,selectorsAdd:l}=r,{atRuleType:d,atRuleParams:i}=t;return a&&this.get(a,n,i,{selectorsAdd:l,atRule:d})},setIdRule(e,t={},s={}){const r=s.state||"",a=s.mediaText||o.getCurrentMedia(),n=o.get("SelectorManager").add({name:e,type:l.TYPE_ID}),d=this.add(n,r,a);return d.setStyle(t,s),d},getIdRule(e,t={}){const s=t.state||"",r=t.mediaText||o.getCurrentMedia(),a=o.get("SelectorManager").get(e,l.TYPE_ID);return a&&this.get(a,s,r)},setClassRule(e,t={},s={}){const r=s.state||"",a=s.mediaText||o.getCurrentMedia(),n=o.get("SelectorManager").add({name:e,type:l.TYPE_CLASS}),d=this.add(n,r,a);return d.setStyle(t,s),d},getClassRule(e,t={}){const s=t.state||"",r=t.mediaText||o.getCurrentMedia(),a=o.get("SelectorManager").get(e,l.TYPE_CLASS);return a&&this.get(a,s,r)},render:()=>i.render().el}}});
//# sourceMappingURL=../sourcemaps/css_composer/index.js.map
