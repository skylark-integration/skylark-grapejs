/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-backbone","skylark-underscore","../../css_composer/view/CssRulesView","../../dom_components/view/ComponentView","../../utils/dom","../../utils/mixins"],function(e,t,s,o,n,i,l){"use strict";return t.View.extend({tagName:"iframe",attributes:{allowfullscreen:"allowfullscreen","data-frame-el":!0},initialize(t){s.bindAll(this,"updateClientY","stopAutoscroll","autoscroll","_emitUpdate");const{model:o,el:n}=this;this.config=e.mixin({},...t.config,{frameView:this}),this.ppfx=this.config.pStylePrefix||"",this.em=this.config.em,this.listenTo(o,"change:head",this.updateHead),o.view=this,l.setViewEl(n,this)},updateHead(){const e=this.getHead();i.empty(e),i.appendVNodes(e,this.model.getHead())},getEl(){return this.el},getWindow(){return this.getEl().contentWindow},getDoc(){return this.getEl().contentDocument},getHead(){return this.getDoc().querySelector("head")},getBody(){return this.getDoc().querySelector("body")},getWrapper(){return this.getBody().querySelector("[data-gjs-type=wrapper]")},getJsContainer(){return this.jsContainer||(this.jsContainer=i.createEl("div",{class:`${this.ppfx}js-cont`})),this.jsContainer},getToolsEl(){const{frameWrapView:e}=this.config;return e&&e.elTools},getGlobalToolsEl(){return this.em.get("Canvas").getGlobalToolsEl()},getHighlighter(){return this._getTool("[data-hl]")},getBadgeEl(){return this._getTool("[data-badge]")},getOffsetViewerEl(){return this._getTool("[data-offset]")},getRect(){return this.rect||(this.rect=this.el.getBoundingClientRect()),this.rect},getOffsetRect(){const{el:e}=this,{scrollTop:t,scrollLeft:s}=this.getBody(),o=e.offsetHeight,n=e.offsetWidth;return{top:e.offsetTop,left:e.offsetLeft,height:o,width:n,scrollTop:t,scrollLeft:s,scrollBottom:t+o,scrollRight:s+n}},_getTool(e){const t=this.getToolsEl();return this[e]||(this[e]=t.querySelector(e)),this[e]},remove(){const{root:e,model:s}=this;this._toggleEffects(),t.View.prototype.remove.apply(this,arguments),e.remove(),s.remove()},startAutoscroll(){this.lastMaxHeight=this.getWrapper().offsetHeight-this.el.offsetHeight,setTimeout(()=>{this._toggleAutoscrollFx(1),requestAnimationFrame(this.autoscroll)},0)},autoscroll(){if(this.dragging){const e=this.em.get("Canvas"),t=this.getWindow(),s=this.getBody().scrollTop,o=this.lastClientY||0,n=e.getConfig().autoscrollLimit,i=this.getRect().height-n;let l=s;if(o<n&&(l-=n-o),o>i&&(l+=o-i),l!==s&&l>0&&l<this.lastMaxHeight){this.getGlobalToolsEl().style.opacity=0,this.showGlobalTools(),t.scrollTo(0,l)}requestAnimationFrame(this.autoscroll)}},updateClientY(e){e.preventDefault(),this.lastClientY=l.getPointerEvent(e).clientY*this.em.getZoomDecimal()},showGlobalTools:s.debounce(function(){this.getGlobalToolsEl().style.opacity=""},50),stopAutoscroll(){this.dragging&&this._toggleAutoscrollFx()},_toggleAutoscrollFx(e){this.dragging=e;const t=this.getWindow(),s=e?"on":"off";l[s](t,"mousemove dragover",this.updateClientY),l[s](t,"mouseup",this.stopAutoscroll)},render(){const{el:e,$el:t,ppfx:s,config:o}=this;return t.attr({class:s+"frame"}),o.scripts.length?this.renderScripts():o.renderContent&&(e.onload=this.renderBody.bind(this)),this},renderScripts(){const{el:t,config:o}=this,n=o=>{if(o.length>0){const l=o.shift(),r=i.createEl("script",e.mixin({type:"text/javascript"},s.isString(l)?{src:l}:l));r.onerror=r.onload=n.bind(null,o),t.contentDocument.head.appendChild(r)}else this.renderBody()};t.onload=(()=>n([...o.scripts]))},renderBody(){const{config:e,model:t,ppfx:r}=this,a=t.get("root"),g=t.get("styles"),{em:h}=e,c=this.getDoc(),d=this.getHead(),p=this.getBody(),f=(this.getWindow(),h.get("Config")),u=[];e.styles.forEach(e=>u.push(s.isString(e)?{tag:"link",attributes:{href:e,rel:"stylesheet"}}:{tag:"link",attributes:{rel:"stylesheet",...e}})),u.length&&i.appendVNodes(d,u);i.append(p,`<style>\n      ${f.baseCss||""}\n\n      .${r}dashed *[data-highlightable] {\n        outline: 1px dashed rgba(170,170,170,0.7);\n        outline-offset: -2px;\n      }\n\n      .${r}selected {\n        outline: 3px solid #3b97e3 !important;\n        outline-offset: -3px;\n      }\n\n      .${r}selected-parent {\n        outline: 2px solid #ffca6f !important\n      }\n\n      .${r}no-select {\n        user-select: none;\n        -webkit-user-select:none;\n        -moz-user-select: none;\n      }\n\n      .${r}freezed {\n        opacity: 0.5;\n        pointer-events: none;\n      }\n\n      .${r}no-pointer {\n        pointer-events: none;\n      }\n\n      .${r}plh-image {\n        background: #f5f5f5;\n        border: none;\n        height: 100px;\n        width: 100px;\n        display: block;\n        outline: 3px solid #ffca6f;\n        cursor: pointer;\n        outline-offset: -2px\n      }\n\n      .${r}grabbing {\n        cursor: grabbing;\n        cursor: -webkit-grabbing;\n      }\n\n      .${r}is__grabbing {\n        overflow-x: hidden;\n      }\n\n      .${r}is__grabbing,\n      .${r}is__grabbing * {\n        cursor: grabbing !important;\n      }\n\n      ${f.canvasCss||""}\n      ${f.protectedCss||""}\n    </style>`),this.root=new n({model:a,config:{...a.config,frameView:this}}).render(),i.append(p,this.root.el),i.append(p,new o({collection:g,config:{...h.get("CssComposer").getConfig(),frameView:this}}).render().el),i.append(p,this.getJsContainer()),l.on(p,"click",e=>e&&"A"==e.target.tagName&&e.preventDefault()),l.on(p,"submit",e=>e&&e.preventDefault()),[{event:"keydown keyup keypress",class:"KeyboardEvent"},{event:"wheel",class:"WheelEvent"}].forEach(e=>e.event.split(" ").forEach(t=>{c.addEventListener(t,t=>this.el.dispatchEvent(i.createCustomEvent(t,e.class)))})),this._toggleEffects(1),t.trigger("loaded")},_toggleEffects(e){(e?l.on:l.off)(this.getWindow(),`${i.motionsEv} resize`,this._emitUpdate)},_emitUpdate(){this.model._emitUpdated()}})});
//# sourceMappingURL=../../sourcemaps/canvas/view/FrameView.js.map
