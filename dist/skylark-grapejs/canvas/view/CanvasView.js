/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-jquery","skylark-backbone","skylark-underscore","../../utils/mixins","./FramesView"],function(e,t,s,i,o,r){"use strict";let n;return s.View.extend({events:{wheel:"onWheel"},template(){const{pfx:e}=this;return`\n      <div class="${e}canvas__frames" data-frames></div>\n      <div id="${e}tools" class="${e}canvas__tools" data-tools></div>\n    `},initialize(t){i.bindAll(this,"clearOff","onKeyPress"),o.on(window,"scroll resize",this.clearOff);const{model:s}=this,n=s.get("frames");this.config=t.config||{},this.em=this.config.em||{},this.pfx=this.config.stylePrefix||"",this.ppfx=this.config.pStylePrefix||"",this.className=this.config.stylePrefix+"canvas";const{em:l,config:a}=this;this.frames=new r({collection:n,config:e.mixin({},a,{canvasView:this,renderContent:1})}),this.listenTo(l,"change:canvasOffset",this.clearOff),this.listenTo(l,"component:selected",this.checkSelected),this.listenTo(s,"change:zoom change:x change:y",this.updateFrames),this.listenTo(n,"loaded:all",()=>l.trigger("loaded")),this.toggleListeners(1)},checkSelected(e,t={}){const{scroll:s}=t,i=this.em.get("currentFrame");s&&e.views.forEach(e=>{e._getFrame()!==i&&e.scrollIntoView(s)})},remove(){s.View.prototype.remove.apply(this,arguments),this.toggleListeners()},preventDefault(e){e&&(e.preventDefault(),e._parentEvent&&e._parentEvent.preventDefault())},toggleListeners(e){o[e?"on":"off"](document,"keypress",this.onKeyPress)},onKeyPress(e){const{em:t}=this;" "===o.getKeyChar(e)&&1!==t.getZoomDecimal()&&(this.preventDefault(e),t.get("Editor").runCommand("core:canvas-move"))},onWheel(e){if((e.ctrlKey||e.metaKey)&&this.em.getConfig("multiFrames")){this.preventDefault(e);const{model:t}=this,s=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),i=t.get("zoom");t.set("zoom",i+2*s)}},updateFrames(e){const{em:t,model:s}=this,{x:i,y:o}=s.attributes,r=this.getZoom(),l={preserveSelected:1},a=r?1/r:1;this.framesArea.style.transform=`scale(${r}) translate(${i*a}px, ${o*a}px)`,this.clearOff(),t.stopDefault(l),t.trigger("canvas:update",e),n&&clearTimeout(n),n=setTimeout(()=>t.runDefault(l),300)},getZoom(){return this.em.getZoomDecimal()},isElInViewport(e){const t=o.getElement(e),s=o.getElRect(t),i=this.getFrameOffset(t),r=s.top,n=s.left;return r>=0&&n>=0&&r<=i.height&&n<=i.width},offset(e,t={}){const s=o.getElRect(e),i=e.ownerDocument.body,{noScroll:r}=t;return{top:s.top+(r?0:i.scrollTop),left:s.left+(r?0:i.scrollLeft),width:s.width,height:s.height}},clearOff(){this.frmOff=null,this.cvsOff=null},getFrameOffset(e){if(!this.frmOff||e){const t=e?e.ownerDocument.defaultView.frameElement:this.frame.el;this.frmOff=this.offset(t)}return this.frmOff},getCanvasOffset(){return this.cvsOff||(this.cvsOff=this.offset(this.el)),this.cvsOff},getElementPos(e,t){const s=this.getZoom();var i=t||{},o=this.getFrameOffset(e),r=this.getCanvasOffset(),n=this.offset(e,t),l=i.avoidFrameOffset?0:o.top,a=i.avoidFrameOffset?0:o.left;return{top:n.top*s+l-r.top,left:n.left*s+a-r.left,height:n.height*s,width:n.width*s,zoom:s,rect:n}},getElementOffsets(e){if(!e||o.isTextNode(e))return{};const t={},s=window.getComputedStyle(e);return["marginTop","marginRight","marginBottom","marginLeft","paddingTop","paddingRight","paddingBottom","paddingLeft"].forEach(e=>{t[e]=parseFloat(s[e])*this.getZoom()}),t},getPosition(e={}){const t=this.frame.el.contentDocument;if(!t)return;const s=t.body,i=this.getZoom(),o=this.getFrameOffset(),r=this.getCanvasOffset(),{noScroll:n}=e;return{top:o.top+(n?0:s.scrollTop)*i-r.top,left:o.left+(n?0:s.scrollLeft)*i-r.left,width:r.width,height:r.height}},updateScript(e){const s=e.model,i=s.getId();e.scriptContainer||(e.scriptContainer=t(`<div data-id="${i}">`),this.getJsContainer().appendChild(e.scriptContainer.get(0))),e.el.id=i,e.scriptContainer.html("");const o=document.createElement("script");o.innerHTML=`\n        setTimeout(function() {\n          var item = document.getElementById('${i}');\n          if (!item) return;\n          (function(){\n            ${s.getScriptString()};\n          }.bind(item))()\n        }, 1);`,setTimeout(()=>e.scriptContainer.get(0).appendChild(o),0)},getJsContainer(e){const t=this.getFrameView(e);return t&&t.getJsContainer()},getFrameView(e){return e&&e._getFrame()||this.em.get("currentFrame")},render(){const{el:e,$el:t,ppfx:s,model:i,em:o,frames:r}=this,n=o.get("CssComposer"),l=i.get("wrapper");t.html(this.template());const a=t.find("[data-frames]");this.framesArea=a.get(0),this.wrapper=l,l&&"function"==typeof l.render&&i.get("frame").set({wrapper:l,root:l.getWrapper(),styles:n.getAll()});const f=t.find("[data-tools]");this.toolsWrapper=f.get(0),f.append(`\n      <div class="${s}tools ${s}tools-gl" style="pointer-events:none">\n        <div class="${s}placeholder">\n          <div class="${s}placeholder-int"></div>\n        </div>\n      </div>\n      <div id="${s}tools" style="pointer-events:none">\n        <div class="${s}badge"></div>\n        <div class="${s}ghost"></div>\n        <div class="${s}toolbar" style="pointer-events:all"></div>\n        <div class="${s}resizer"></div>\n        <div class="${s}offset-v"></div>\n        <div class="${s}offset-fixed-v"></div>\n      </div>\n    `);const c=e.querySelector(`#${s}tools`);this.hlEl=e.querySelector(`.${s}highlighter`),this.badgeEl=e.querySelector(`.${s}badge`),this.placerEl=e.querySelector(`.${s}placeholder`),this.ghostEl=e.querySelector(`.${s}ghost`),this.toolbarEl=e.querySelector(`.${s}toolbar`),this.resizerEl=e.querySelector(`.${s}resizer`),this.offsetEl=e.querySelector(`.${s}offset-v`),this.fixedOffsetEl=e.querySelector(`.${s}offset-fixed-v`),this.toolsGlobEl=e.querySelector(`.${s}tools-gl`),this.toolsEl=c,this.el.className=this.className;const h=i.get("frames");return h.listenToLoad(),r.render(),o.setCurrentFrame(h.at(0).view),a.append(r.el),this.frame=h.at(0).view,this}})});
//# sourceMappingURL=../../sourcemaps/canvas/view/CanvasView.js.map
