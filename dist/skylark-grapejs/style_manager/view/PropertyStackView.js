/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-underscore","./PropertiesView","./PropertyCompositeView","./LayersView","../../code_manager/model/CssGenerator"],function(e,t,s,a,r){"use strict";const l=new r;return s.extend({templateInput(){const e=this.pfx;this.ppfx;return`\n      <div class="${e}field ${e}stack">\n        <button type="button" id="${e}add" data-add-layer>+</button>\n        <div data-layers-wrapper></div>\n      </div>\n    `},init(){const e=this.model;this.pfx;e.set("stackIndex",null),this.events["click [data-add-layer]"]="addLayer",this.listenTo(e,"change:stackIndex",this.indexChanged),this.listenTo(e,"updateValue",this.inputValueChanged),this.delegateEvents()},targetUpdated(...e){if(this.model.get("detached")){const{status:e}=this._getTargetData();this.setStatus(e),this.checkVisibility()}else s.prototype.targetUpdated.apply(this,e);this.refreshLayers()},getLayers(){return this.model.get("layers")},indexChanged(e){const t=this.model;this.getLayers().active(t.get("stackIndex"))},addLayer(){const e=this.model,t=this.getLayers(),s=e.get("prepend"),a=e.get("properties").deepClone();a.each(e=>e.set("value",""));const r=t.add({properties:a},{active:1,...s&&{at:0}});this.inputValueChanged(),e.set("stackIndex",t.indexOf(r))},inputValueChanged(){const e=this.model;this.elementUpdated(),e.get("detached")?e.get("properties").each(e=>e.trigger("change:value")):e.set("value",this.getLayerValues())},setValue(){},getLayerValues(){return this.getLayers().getFullValue()},_getClassRule(e={}){const{em:t}=this,{skipAdd:s=1}=e,a=t.getSelected(),r=t.get("StyleManager").getModelToStyle(a,{skipAdd:s,useClasses:1});return r!==a&&r},_getParentTarget(e,t={}){const{em:s,model:a}=this,r=a.get("property"),i=t.isValid||(e=>e.getStyle()[r]),g=s.get("CssComposer").getAll().filter(t=>t.selectorsToString()===e.getSelectorsString()).reduce((e,t)=>(e[t.getAtRule()]=t,e),{}),n=l.sortMediaObject(g).map(e=>e.value),d=n.indexOf(e),o=n.splice(0,d);let h;for(let e=o.length-1;e>-1;e--){const t=o[e];if(i(t)){h=t;break}}return h},refreshLayers(){let t=[];const{model:s,em:a}=this,r=this.getLayers(),l=s.get("detached"),i=s.get("property"),g=this.getTarget(),n=this.getComputedValue(),d=a.getSelected();let o,h,p,u,c,y;if(l){h=g?g.getStyle():{};const a=t=>{const a=s.get("properties").at(0).get("property");return t&&!e.isUndefined(t.getStyle()[a])};if(!e.keys(h).length&&n&&d){const e={isValid:e=>a(e)};(u=this._getParentTarget(g,e))?h=u.getStyle():(p=this._getClassRule(),u=!(c=a(p)&&p.getStyle())&&this._getParentTarget(this._getClassRule({skipAdd:0}),e),y=a(u)&&u.getStyle(),h=c||y||{})}o=h,t=r.getLayersFromStyle(h)}else{let e=this.getTargetValue({ignoreDefault:1});!e&&n&&((u=this._getParentTarget(g))?e=u.getStyle()[i]:(y=(u=!(c=(p=this._getClassRule())&&p.getStyle()[i])&&this._getParentTarget(this._getClassRule({skipAdd:0})))&&u.getStyle()[i],e=c||y||n)),o=e=e==s.getDefaultValue()?"":e,t=r.getLayersFromValue(e)}const f=s.getLayersFromTarget(g,{resultValue:o,layersObj:t})||t;r.reset(),r.add(f),s.set({stackIndex:null},{silent:!0})},getTargetValue(t={}){let a=s.prototype.getTargetValue.call(this,t);const{detached:r}=this.model.attributes;return e.isUndefined(a)&&!r&&(a=this.model.getValueFromStyle(this.getTarget().getStyle())),a},onRender(){const e=this,s=this.model,r=this.el.querySelector("[data-layers-wrapper]"),l={target:this.target,propTarget:this.propTarget,onChange(t,a,r){const l=a.model;if(s.get("detached")){const t=l.get("property"),s=l.getDefaultValue(),i=e.getLayers().getPropertyValues(t,s);a.updateTargetStyle(i,null,r)}else if("updated"==s.get("status")){const e=s.getFullValue();s.set("value",e,r),!e&&a.updateTargetStyle(e,null,r)}}},i=new a({collection:this.getLayers(),stackModel:s,preview:s.get("preview"),config:this.config,propsConfig:l}).render().el;new t({target:this.target,collection:this.model.get("properties"),stackModel:s,config:this.config,onChange:l.onChange,propTarget:l.propTarget}).render(),r.appendChild(i)}})});
//# sourceMappingURL=../../sourcemaps/style_manager/view/PropertyStackView.js.map
