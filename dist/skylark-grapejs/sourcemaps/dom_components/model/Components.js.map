{"version":3,"sources":["dom_components/model/Components.js"],"names":["define","langx","Backbone","_","Component","Collection","extend","[object Object]","models","opt","this","listenTo","onAdd","config","em","model","attrs","options","df","get","componentTypes","domc","it","length","id","type","logWarning","value","cssc","parsed","parseHtml","require","default","checkId","html","css","componentsById","temporary","addCollection","mixin","isString","parseString","isArray","forEach","item","index","isMult","filter","i","map","processDef","prototype","add","apply","mdl","cid","ccid","processor","modelPr","each","val","key","$$typeof","props","parser","parserHtml","includes","comps","children","res","splitPropsFromAttr","attributes","components","getType","tagName","c","opts","style","getStyle","avoidInline","getConfig","isEmpty","name","setClassRule","setStyle","addClass"],"mappings":"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","file":"../../../dom_components/model/Components.js","sourcesContent":["define([\n    \"skylark-langx/langx\",\n    'skylark-backbone',\n    'skylark-underscore'\n], function (langx,Backbone, _) {\n    'use strict';\n    let Component;\n    return Backbone.Collection.extend({\n        initialize(models, opt = {}) {\n            this.opt = opt;\n            this.listenTo(this, 'add', this.onAdd);\n            this.config = opt.config;\n            this.em = opt.em;\n            const {em} = this;\n            this.model = (attrs, options) => {\n                var model;\n                const df = opt.em.get('DomComponents').componentTypes;\n                options.em = opt.em;\n                options.config = opt.config;\n                options.componentTypes = df;\n                options.domc = opt.domc;\n                for (var it = 0; it < df.length; it++) {\n                    var dfId = df[it].id;\n                    if (dfId == attrs.type) {\n                        model = df[it].model;\n                        break;\n                    }\n                }\n                if (!model) {\n                    model = df[df.length - 1].model;\n                    em && attrs.type && em.logWarning(`Component type '${ attrs.type }' not found`, {\n                        attrs,\n                        options\n                    });\n                }\n                return new model(attrs, options);\n            };\n        },\n        parseString(value, opt = {}) {\n            const {em} = this;\n            const {domc} = this.opt;\n            const cssc = em.get('CssComposer');\n            const parsed = em.get('Parser').parseHtml(value);\n            if (!Component)\n                Component = require('./Component').default;\n            Component.checkId(parsed.html, parsed.css, domc.componentsById);\n            if (parsed.css && cssc && !opt.temporary) {\n                cssc.addCollection(parsed.css, langx.mixin({},opt,{\n                    extend: 1\n                }));\n            }\n            return parsed.html;\n        },\n        add(models, opt = {}) {\n            if (_.isString(models)) {\n                models = this.parseString(models, opt);\n            } else if (_.isArray(models)) {\n                models.forEach((item, index) => {\n                    if (_.isString(item)) {\n                        models[index] = this.parseString(item, opt);\n                    }\n                });\n            }\n            const isMult = _.isArray(models);\n            models = (isMult ? models : [models]).filter(i => i).map(model => this.processDef(model));\n            models = isMult ? models : models[0];\n            return Backbone.Collection.prototype.add.apply(this, [\n                models,\n                opt\n            ]);\n        },\n        processDef(mdl) {\n            if (mdl.cid && mdl.ccid)\n                return mdl;\n            const {em, config = {}} = this;\n            const {processor} = config;\n            let model = mdl;\n            if (processor) {\n                model = { ...model };\n                const modelPr = processor(model);\n                if (modelPr) {\n                    _.each(model, (val, key) => delete model[key]);\n                    _.extend(model, modelPr);\n                }\n            }\n            if (model.$$typeof && typeof model.props == 'object') {\n                model = { ...model };\n                model.props = { ...model.props };\n                const domc = em.get('DomComponents');\n                const parser = em.get('Parser');\n                const {parserHtml} = parser;\n                _.each(model, (value, key) => {\n                    if (!_.includes([\n                            'props',\n                            'type'\n                        ], key))\n                        delete model[key];\n                });\n                const {props} = model;\n                const comps = props.children;\n                delete props.children;\n                delete model.props;\n                const res = parserHtml.splitPropsFromAttr(props);\n                model.attributes = res.attrs;\n                if (comps) {\n                    model.components = comps;\n                }\n                if (!model.type) {\n                    model.type = 'textnode';\n                } else if (!domc.getType(model.type)) {\n                    model.tagName = model.type;\n                    delete model.type;\n                }\n                _.extend(model, res.props);\n            }\n            return model;\n        },\n        onAdd(model, c, opts = {}) {\n            const em = this.em;\n            const style = model.getStyle();\n            const avoidInline = em && em.getConfig('avoidInlineStyle');\n            if (!_.isEmpty(style) && !avoidInline && em && em.get && em.getConfig('forceClass') && !opts.temporary) {\n                const name = model.cid;\n                const rule = em.get('CssComposer').setClassRule(name, style);\n                model.setStyle({});\n                model.addClass(name);\n            }\n        }\n    });\n});"]}