{"version":3,"sources":["commands/index.js"],"names":["define","a","CommandAbstract","defaults","b","em","c","commands","defaultCommands","active","commandsDef","name","[object Object]","config","ppfx","pStylePrefix","stylePrefix","k","obj","id","this","add","run","ed","runCommand","sender","opts","dragger","getModel","event","target","sel","getSelected","selAll","getSelectedAll","nativeDrag","type","defComOptions","preserveSelected","mode","get","hideTlb","stopDefault","altMode","includes","forEach","trigger","logWarning","setTimeout","onStart","data","eventDrag","onDrag","onEnd","e","runDefault","set","select","emitUpdate","cancelled","guidesInfo","dataTransfer","setDragImage","view","el","cmdMove","Commands","onEndMoveFromModel","initSorterFromModels","UndoManager","undo","redo","item","oldCmd","cmd","require","default","cmdName","on","args","model","loadDefaultCommands","isFunction","stop","noStop","initialize","extend","command","cmdObj","constructor","prototype","filter","has","getAll","options","stopCommand","getActive","hasOwnProperty","result","editor","isActive","force","strict","callRun","abort","callStop","create"],"mappings":"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","file":"../../commands/index.js","sourcesContent":["define([\n    'skylark-underscore',\n    './view/CommandAbstract',\n    './config/config',\n    '../../dom_components/model/Component'\n], function (a, CommandAbstract, defaults, b) {\n    'use strict';\n    return () => {\n        let em;\n        let c = {};\n        const commands = {};\n        const defaultCommands = {};\n        const active = {};\n        const commandsDef = [\n            [\n                'preview',\n                'Preview',\n                'preview'\n            ],\n            [\n                'resize',\n                'Resize',\n                'resize'\n            ],\n            [\n                'fullscreen',\n                'Fullscreen',\n                'fullscreen'\n            ],\n            [\n                'copy',\n                'CopyComponent'\n            ],\n            [\n                'paste',\n                'PasteComponent'\n            ],\n            [\n                'canvas-move',\n                'CanvasMove'\n            ],\n            [\n                'canvas-clear',\n                'CanvasClear'\n            ],\n            [\n                'open-code',\n                'ExportTemplate',\n                'export-template'\n            ],\n            [\n                'open-layers',\n                'OpenLayers',\n                'open-layers'\n            ],\n            [\n                'open-styles',\n                'OpenStyleManager',\n                'open-sm'\n            ],\n            [\n                'open-traits',\n                'OpenTraitManager',\n                'open-tm'\n            ],\n            [\n                'open-blocks',\n                'OpenBlocks',\n                'open-blocks'\n            ],\n            [\n                'open-assets',\n                'OpenAssets',\n                'open-assets'\n            ],\n            [\n                'component-select',\n                'SelectComponent',\n                'select-comp'\n            ],\n            [\n                'component-outline',\n                'SwitchVisibility',\n                'sw-visibility'\n            ],\n            [\n                'component-offset',\n                'ShowOffset',\n                'show-offset'\n            ],\n            [\n                'component-move',\n                'MoveComponent',\n                'move-comp'\n            ],\n            [\n                'component-next',\n                'ComponentNext'\n            ],\n            [\n                'component-prev',\n                'ComponentPrev'\n            ],\n            [\n                'component-enter',\n                'ComponentEnter'\n            ],\n            [\n                'component-exit',\n                'ComponentExit',\n                'select-parent'\n            ],\n            [\n                'component-delete',\n                'ComponentDelete'\n            ],\n            [\n                'component-style-clear',\n                'ComponentStyleClear'\n            ],\n            [\n                'component-drag',\n                'ComponentDrag'\n            ]\n        ];\n        const add = function (id, obj) {\n            if (a.isFunction(obj))\n                obj = { run: obj };\n            if (!obj.stop)\n                obj.noStop = 1;\n            delete obj.initialize;\n            obj.id = id;\n            commands[id] = CommandAbstract.extend(obj);\n            return this;\n        };\n        return {\n            CommandAbstract,\n            name: 'Commands',\n            init(config = {}) {\n                c = {\n                    ...defaults,\n                    ...config\n                };\n                em = c.em;\n                const ppfx = c.pStylePrefix;\n                if (ppfx)\n                    c.stylePrefix = ppfx + c.stylePrefix;\n                for (let k in c.defaults) {\n                    const obj = c.defaults[k];\n                    if (obj.id)\n                        this.add(obj.id, obj);\n                }\n                defaultCommands['tlb-delete'] = {\n                    run(ed) {\n                        return ed.runCommand('core:component-delete');\n                    }\n                };\n                defaultCommands['tlb-clone'] = {\n                    run(ed) {\n                        ed.runCommand('core:copy');\n                        ed.runCommand('core:paste');\n                    }\n                };\n                defaultCommands['tlb-move'] = {\n                    run(ed, sender, opts = {}) {\n                        let dragger;\n                        const em = ed.getModel();\n                        const event = opts && opts.event;\n                        const {target} = opts;\n                        const sel = target || ed.getSelected();\n                        const selAll = target ? [target] : [...ed.getSelectedAll()];\n                        const nativeDrag = event && event.type == 'dragstart';\n                        const defComOptions = { preserveSelected: 1 };\n                        const modes = [\n                            'absolute',\n                            'translate'\n                        ];\n                        const mode = sel.get('dmode') || em.get('dmode');\n                        const hideTlb = () => em.stopDefault(defComOptions);\n                        const altMode = a.includes(modes, mode);\n                        selAll.forEach(sel => sel.trigger('disable'));\n                        if (!sel || !sel.get('draggable')) {\n                            return em.logWarning('The element is not draggable');\n                        }\n                        nativeDrag ? setTimeout(hideTlb, 0) : hideTlb();\n                        const onStart = data => {\n                            em.trigger(`${ b.eventDrag }:start`, data);\n                        };\n                        const onDrag = data => {\n                            em.trigger(b.eventDrag, data);\n                        };\n                        const onEnd = (e, opts, data) => {\n                            em.runDefault(defComOptions);\n                            selAll.forEach(sel => sel.set('status', 'selected'));\n                            ed.select(selAll);\n                            sel.emitUpdate();\n                            em.trigger(`${ b.eventDrag }:end`, data);\n                            (altMode || data.cancelled) && em.set('_cmpDrag', 1);\n                        };\n                        if (altMode) {\n                            dragger = ed.runCommand('core:component-drag', {\n                                guidesInfo: 1,\n                                mode,\n                                target: sel,\n                                onStart,\n                                onDrag,\n                                onEnd,\n                                event\n                            });\n                        } else {\n                            if (nativeDrag) {\n                                event.dataTransfer.setDragImage(sel.view.el, 0, 0);\n                            }\n                            const cmdMove = ed.Commands.get('move-comp');\n                            cmdMove.onStart = onStart;\n                            cmdMove.onDrag = onDrag;\n                            cmdMove.onEndMoveFromModel = onEnd;\n                            cmdMove.initSorterFromModels(selAll);\n                        }\n                        selAll.forEach(sel => sel.set('status', 'freezed-selected'));\n                    }\n                };\n                defaultCommands['core:undo'] = e => e.UndoManager.undo();\n                defaultCommands['core:redo'] = e => e.UndoManager.redo();\n                commandsDef.forEach(item => {\n                    const oldCmd = item[2];\n                    const cmd = require(`./view/${ item[1] }`).default;\n                    const cmdName = `core:${ item[0] }`;\n                    defaultCommands[cmdName] = cmd;\n                    if (oldCmd) {\n                        defaultCommands[oldCmd] = cmd;\n                        [\n                            'run',\n                            'stop'\n                        ].forEach(name => {\n                            em.on(`${ name }:${ oldCmd }`, (...args) => em.trigger(`${ name }:${ cmdName }`, ...args));\n                        });\n                    }\n                });\n                if (c.em)\n                    c.model = c.em.get('Canvas');\n                this.loadDefaultCommands();\n                return this;\n            },\n            add,\n            get(id) {\n                let el = commands[id];\n                if (a.isFunction(el)) {\n                    el = new el(c);\n                    commands[id] = el;\n                } else if (!el) {\n                    em.logWarning(`'${ id }' command not found`);\n                }\n                return el;\n            },\n            extend(id, cmd = {}) {\n                const command = this.get(id);\n                if (command) {\n                    const cmdObj = {\n                        ...command.constructor.prototype,\n                        ...cmd\n                    };\n                    this.add(id, cmdObj);\n                    const oldCmd = commandsDef.filter(cmd => `core:${ cmd[0] }` === id && cmd[2])[0];\n                    oldCmd && this.add(oldCmd[2], cmdObj);\n                }\n                return this;\n            },\n            has(id) {\n                return !!commands[id];\n            },\n            getAll() {\n                return commands;\n            },\n            run(id, options = {}) {\n                return this.runCommand(this.get(id), options);\n            },\n            stop(id, options = {}) {\n                return this.stopCommand(this.get(id), options);\n            },\n            isActive(id) {\n                return this.getActive().hasOwnProperty(id);\n            },\n            getActive() {\n                return active;\n            },\n            loadDefaultCommands() {\n                for (var id in defaultCommands) {\n                    this.add(id, defaultCommands[id]);\n                }\n                return this;\n            },\n            runCommand(command, options = {}) {\n                let result;\n                if (command && command.run) {\n                    const id = command.id;\n                    const editor = em.get('Editor');\n                    if (!this.isActive(id) || options.force || !c.strict) {\n                        result = command.callRun(editor, options);\n                        if (id && command.stop && !command.noStop && !options.abort) {\n                            active[id] = result;\n                        }\n                    }\n                }\n                return result;\n            },\n            stopCommand(command, options = {}) {\n                let result;\n                if (command && command.run) {\n                    const id = command.id;\n                    const editor = em.get('Editor');\n                    if (this.isActive(id) || options.force || !c.strict) {\n                        if (id)\n                            delete active[id];\n                        result = command.callStop(editor, options);\n                    }\n                }\n                return result;\n            },\n            create(command) {\n                if (!command.stop)\n                    command.noStop = 1;\n                const cmd = CommandAbstract.extend(command);\n                return new cmd(c);\n            }\n        };\n    };\n});"]}