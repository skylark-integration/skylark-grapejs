{"version":3,"sources":["style_manager/index.js"],"names":["define","langx","_","defaults","Sectors","Properties","SectorsView","c","properties","sectors","SectView","name","getConfig","[object Object]","config","ppfx","mxinin","conf","pStylePrefix","this","em","stylePrefix","collection","target","add","elTo","appendTo","isElement","document","querySelector","appendChild","render","id","sector","opts","result","getSector","res","where","warn","_logNoSector","getSectors","remove","sectorId","property","prop","get","length","props","getProperties","getProperty","model","options","skipAdd","classes","getId","um","cssC","sm","smConf","state","devicePreviewMode","valid","getStyleable","hasClasses","useClasses","componentFirst","rule","stop","deviceW","getCurrentMedia","avoidInlineStyle","getIdRule","setIdRule","is","set","start","definition","addType","getType","getTypes","view","type","mixin","setTarget","getEmitter","propTarget","el","logWarning"],"mappings":"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","file":"../../style_manager/index.js","sourcesContent":["define([\n    \"skylark-langx/langx\",\n    'skylark-underscore',\n    './config/config',\n    './model/Sectors',\n    './model/Properties',\n    './view/SectorsView'\n], function (langx,_, defaults, Sectors, Properties, SectorsView) {\n    'use strict';\n    return () => {\n        var c = {};\n        let properties;\n        var sectors, SectView;\n        return {\n            name: 'StyleManager',\n            getConfig() {\n                return c;\n            },\n            init(config) {\n                c = langx.mxinin({},defaults,conf);\n                const ppfx = c.pStylePrefix;\n                this.em = c.em;\n                if (ppfx)\n                    c.stylePrefix = ppfx + c.stylePrefix;\n                properties = new Properties();\n                sectors = new Sectors([], c);\n                SectView = new SectorsView({\n                    collection: sectors,\n                    target: c.em,\n                    config: c\n                });\n                return this;\n            },\n            onLoad() {\n                sectors.add(c.sectors);\n            },\n            postRender() {\n                const elTo = this.getConfig().appendTo;\n                if (elTo) {\n                    const el = _.isElement(elTo) ? elTo : document.querySelector(elTo);\n                    el.appendChild(this.render());\n                }\n            },\n            addSector(id, sector, opts = {}) {\n                let result = this.getSector(id);\n                if (!result) {\n                    sector.id = id;\n                    result = sectors.add(sector, opts);\n                }\n                return result;\n            },\n            getSector(id, opts = {}) {\n                const res = sectors.where({ id })[0];\n                !res && opts.warn && this._logNoSector(id);\n                return res;\n            },\n            removeSector(id) {\n                return this.getSectors().remove(this.getSector(id, { warn: 1 }));\n            },\n            getSectors() {\n                return sectors;\n            },\n            addProperty(sectorId, property, opts = {}) {\n                const sector = this.getSector(sectorId, { warn: 1 });\n                let prop = null;\n                if (sector)\n                    prop = sector.get('properties').add(property, opts);\n                return prop;\n            },\n            getProperty(sectorId, name) {\n                const sector = this.getSector(sectorId, { warn: 1 });\n                let prop = null;\n                if (sector) {\n                    prop = sector.get('properties').where({ property: name });\n                    prop = prop.length == 1 ? prop[0] : prop;\n                }\n                return prop;\n            },\n            removeProperty(sectorId, name) {\n                const props = this.getProperties(sectorId);\n                return props && props.remove(this.getProperty(sectorId, name));\n            },\n            getProperties(sectorId) {\n                let props = null;\n                const sector = this.getSector(sectorId, { warn: 1 });\n                if (sector)\n                    props = sector.get('properties');\n                return props;\n            },\n            getModelToStyle(model, options = {}) {\n                const em = c.em;\n                const {skipAdd} = options;\n                const classes = model.get('classes');\n                const id = model.getId();\n                if (em) {\n                    const config = em.getConfig();\n                    const um = em.get('UndoManager');\n                    const cssC = em.get('CssComposer');\n                    const sm = em.get('SelectorManager');\n                    const smConf = sm ? sm.getConfig() : {};\n                    const state = !config.devicePreviewMode ? em.get('state') : '';\n                    const valid = classes.getStyleable();\n                    const hasClasses = valid.length;\n                    const useClasses = !smConf.componentFirst || options.useClasses;\n                    const opts = { state };\n                    let rule;\n                    um.stop();\n                    if (hasClasses && useClasses) {\n                        const deviceW = em.getCurrentMedia();\n                        rule = cssC.get(valid, state, deviceW);\n                        if (!rule && !skipAdd) {\n                            rule = cssC.add(valid, state, deviceW);\n                        }\n                    } else if (config.avoidInlineStyle) {\n                        rule = cssC.getIdRule(id, opts);\n                        !rule && !skipAdd && (rule = cssC.setIdRule(id, {}, opts));\n                        if (model.is('wrapper'))\n                            rule.set('wrapper', 1);\n                    }\n                    rule && (model = rule);\n                    um.start();\n                }\n                return model;\n            },\n            addType(id, definition) {\n                properties.addType(id, definition);\n            },\n            getType(id) {\n                return properties.getType(id);\n            },\n            getTypes() {\n                return properties.getTypes();\n            },\n            createType(id, {model = {}, view = {}} = {}) {\n                const type = this.getType(id);\n                if (type) {\n                    return new type.view(\n                        langx.mixin({\n                            model: new type.model(model),\n                            config: c,\n                        },view)\n                    );\n                }\n            },\n            setTarget(target, opts) {\n                return SectView.setTarget(target, opts);\n            },\n            getEmitter() {\n                return SectView.propTarget;\n            },\n            render() {\n                return SectView.render().el;\n            },\n            _logNoSector(sectorId) {\n                const {em} = this;\n                em && em.logWarning(`'${ sectorId }' sector not found`);\n            }\n        };\n    };\n});"]}