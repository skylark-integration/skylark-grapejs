{"version":3,"sources":["style_manager/view/SectorsView.js"],"names":["define","Backbone","a","b","c","SectorView","View","extend","[object Object]","o","config","this","pfx","stylePrefix","ppfx","pStylePrefix","target","Events","body","document","dummy","createElement","Date","getTime","appendChild","computedDefault","window","getComputedStyle","removeChild","propTarget","coll","collection","listenTo","addTo","render","targetUpdated","model","opts","addToCollection","targets","enable","forEach","trg","el","getEl","classList","em","pt","getSelectedAll","getSelected","mdToClear","toHTML","toggleStateCls","state","get","devicePreviewMode","componentFirst","getConfig","helper","isTaggableNode","stateStr","computed","getModelToStyle","style","cc","rules","getAll","helperRule","getClassRule","remove","add","setClassRule","set","setStyle","appendStateRule","getStyle","trigger","trgs","isArray","targetIsClass","stylable","models","isString","rule","filter","getFullString","selectors","selectorsAdd","push","fragmentEl","appendTo","rendered","id","name","properties","appendAtIndex","at","frag","createDocumentFragment","$el","empty","each","append","addClass"],"mappings":"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","file":"../../../style_manager/view/SectorsView.js","sourcesContent":["define([\n    'skylark-backbone',\n    'skylark-underscore',\n    '../../utils/mixins',\n    '../../utils/dom',\n    './SectorView'\n], function (Backbone, a, b, c, SectorView) {\n    'use strict';\n    const helperCls = 'hc-state';\n    return Backbone.View.extend({\n        initialize(o = {}) {\n            const config = o.config || {};\n            this.pfx = config.stylePrefix || '';\n            this.ppfx = config.pStylePrefix || '';\n            this.target = o.target || {};\n            this.config = config;\n            const target = {};\n            a.extend(target, Backbone.Events);\n            const body = document.body;\n            const dummy = document.createElement(`el-${ new Date().getTime() }`);\n            body.appendChild(dummy);\n            target.computedDefault = { ...window.getComputedStyle(dummy) };\n            body.removeChild(dummy);\n            this.propTarget = target;\n            const coll = this.collection;\n            const events = 'component:toggled component:update:classes change:state change:device frame:resized';\n            this.listenTo(coll, 'add', this.addTo);\n            this.listenTo(coll, 'reset', this.render);\n            this.listenTo(this.target, events, this.targetUpdated);\n        },\n        addTo(model, coll, opts = {}) {\n            this.addToCollection(model, null, opts);\n        },\n        toggleStateCls(targets = [], enable) {\n            targets.forEach(trg => {\n                const el = trg.getEl();\n                el && el.classList[enable ? 'add' : 'remove'](helperCls);\n            });\n        },\n        targetUpdated(trg) {\n            const em = this.target;\n            const pt = this.propTarget;\n            const targets = em.getSelectedAll();\n            let model = em.getSelected();\n            const mdToClear = trg && !!trg.toHTML ? trg : model;\n            mdToClear && this.toggleStateCls([mdToClear]);\n            if (!model)\n                return;\n            const config = em.get('Config');\n            const state = !config.devicePreviewMode ? em.get('state') : '';\n            const {componentFirst} = em.get('SelectorManager').getConfig();\n            const el = model.getEl();\n            pt.helper = null;\n            pt.targets = null;\n            if (el && b.isTaggableNode(el)) {\n                const stateStr = state ? `:${ state }` : null;\n                pt.computed = window.getComputedStyle(el, stateStr);\n            }\n            const appendStateRule = (style = {}) => {\n                const cc = em.get('CssComposer');\n                const rules = cc.getAll();\n                let helperRule = cc.getClassRule(helperCls);\n                if (!helperRule) {\n                    helperRule = cc.setClassRule(helperCls);\n                } else {\n                    rules.remove(helperRule);\n                    rules.add(helperRule);\n                }\n                helperRule.set('important', 1);\n                helperRule.setStyle(style);\n                pt.helper = helperRule;\n            };\n            model = em.get('StyleManager').getModelToStyle(model);\n            if (state) {\n                appendStateRule(model.getStyle());\n                this.toggleStateCls(targets, 1);\n            }\n            pt.model = model;\n            if (componentFirst)\n                pt.targets = targets;\n            pt.trigger('update');\n        },\n        setTarget(target, opts = {}) {\n            const em = this.target;\n            const trgs = a.isArray(target) ? target : [target];\n            const {targetIsClass, stylable} = opts;\n            const models = [];\n            trgs.forEach(target => {\n                let model = target;\n                if (a.isString(target)) {\n                    let rule;\n                    const rules = em.get('CssComposer').getAll();\n                    if (targetIsClass) {\n                        rule = rules.filter(rule => rule.get('selectors').getFullString() === target)[0];\n                    }\n                    if (!rule) {\n                        rule = rules.filter(rule => rule.get('selectorsAdd') === target)[0];\n                    }\n                    if (!rule) {\n                        rule = rules.add({\n                            selectors: [],\n                            selectorsAdd: target\n                        });\n                    }\n                    stylable && rule.set({ stylable });\n                    model = rule;\n                }\n                models.push(model);\n            });\n            const pt = this.propTarget;\n            pt.targets = models;\n            pt.trigger('update');\n            return models;\n        },\n        addToCollection(model, fragmentEl, opts = {}) {\n            const {pfx, target, propTarget, config, el} = this;\n            const appendTo = fragmentEl || el;\n            const rendered = new SectorView({\n                model,\n                id: `${ pfx }${ model.get('id') }`,\n                name: model.get('name'),\n                properties: model.get('properties'),\n                target,\n                propTarget,\n                config\n            }).render().el;\n            c.appendAtIndex(appendTo, rendered, opts.at);\n            return rendered;\n        },\n        render() {\n            const frag = document.createDocumentFragment();\n            const $el = this.$el;\n            const pfx = this.pfx;\n            const ppfx = this.ppfx;\n            $el.empty();\n            this.collection.each(model => this.addToCollection(model, frag));\n            $el.append(frag);\n            $el.addClass(`${ pfx }sectors ${ ppfx }one-bg ${ ppfx }two-color`);\n            return this;\n        }\n    });\n});"]}