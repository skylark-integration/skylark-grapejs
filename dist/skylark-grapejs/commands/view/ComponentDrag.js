/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-underscore","../../utils/Dragger"],function(t,e){"use strict";return{run(i,s,n={}){t.bindAll(this,"setPosition","onStart","onDrag","onEnd","getPosition","getGuidesStatic","renderGuide","getGuidesTarget");const{target:o,event:r,mode:a,dragger:d={}}=n,g={doc:o.getEl().ownerDocument,onStart:this.onStart,onEnd:this.onEnd,onDrag:this.onDrag,getPosition:this.getPosition,setPosition:this.setPosition,guidesStatic:()=>this.guidesStatic,guidesTarget:()=>this.guidesTarget,...d};this.setupGuides(),this.opts=n,this.editor=i,this.em=i.getModel(),this.target=o,this.isTran="translate"==a,this.guidesContainer=this.getGuidesContainer(),this.guidesTarget=this.getGuidesTarget(),this.guidesStatic=this.getGuidesStatic();let h=this.dragger;return h?h.setOptions(g):(h=new e(g),this.dragger=h),r&&h.start(r),this.toggleDrag(1),this.em.trigger("dmode:start",this.getEventOpts()),h},getEventOpts(){return{mode:this.opts.mode,target:this.target,guidesTarget:this.guidesTarget,guidesStatic:this.guidesStatic}},stop(){this.toggleDrag()},setupGuides(){(this.guides||[]).forEach(t=>{const{guide:e}=t;e&&e.parentNode.removeChild(e)}),this.guides=[]},getGuidesContainer(){let{guidesEl:e}=this;if(!e){const{editor:i,em:s,opts:n}=this,o=i.getConfig("stylePrefix"),r=document.createElement("div"),a=document.createElement("div"),d=`<div class="${o}guide-info__line ${o}danger-bg">\n        <div class="${o}guide-info__content ${o}danger-color"></div>\n      </div>`;(e=document.createElement("div")).className=`${o}guides`,r.className=`${o}guide-info ${o}guide-info__x`,a.className=`${o}guide-info ${o}guide-info__y`,r.innerHTML=d,a.innerHTML=d,e.appendChild(r),e.appendChild(a),i.Canvas.getGlobalToolsEl().appendChild(e),this.guidesEl=e,this.elGuideInfoX=r,this.elGuideInfoY=a,this.elGuideInfoContentX=r.querySelector(`.${o}guide-info__content`),this.elGuideInfoContentY=a.querySelector(`.${o}guide-info__content`),s.on("canvas:update frame:scroll",t.debounce(()=>{this.updateGuides(),n.debug&&this.guides.forEach(t=>this.renderGuide(t))},200))}return e},getGuidesStatic(){let e=[];const i=this.target.getEl(),{parentNode:s={}}=i;return t.each(s.children,t=>e=e.concat(i!==t?this.getElementGuides(t):[])),e.concat(this.getElementGuides(s))},getGuidesTarget(){return this.getElementGuides(this.target.getEl())},updateGuides(e){let i,s;(e||this.guides).forEach(e=>{const{origin:n}=e,o=i===n?s:this.getElementPos(n);i=n,s=o,t.each(this.getGuidePosUpdate(e,o),(t,i)=>e[i]=t),e.originRect=o})},getGuidePosUpdate(t,e){const i={},{top:s,height:n,left:o,width:r}=e;switch(t.type){case"t":i.y=s;break;case"b":i.y=s+n;break;case"l":i.x=o;break;case"r":i.x=o+r;break;case"x":i.x=o+r/2;break;case"y":i.y=s+n/2}return i},renderGuide(t={}){const e=t.guide||document.createElement("div"),i=t.active?2:1;let s=e.children[0];return e.style=`position: absolute; background-color: ${t.active?"green":"red"};`,e.children.length||((s=document.createElement("div")).style="position: absolute; color: red; padding: 5px; top: 0; left: 0;",e.appendChild(s)),t.y?(e.style.width="100%",e.style.height=`${i}px`,e.style.top=`${t.y}px`,e.style.left=0):(e.style.width=`${i}px`,e.style.height="100%",e.style.left=`${t.x}px`,e.style.top="0px"),!t.guide&&this.guidesContainer.appendChild(e),e},getElementPos(t){return this.editor.Canvas.getElementPos(t,{noScroll:1})},getElementGuides(t){const{opts:e}=this,i=this.getElementPos(t),{top:s,height:n,left:o,width:r}=i,a=[{type:"t",y:s},{type:"b",y:s+n},{type:"l",x:o},{type:"r",x:o+r},{type:"x",x:o+r/2},{type:"y",y:s+n/2}].map(s=>({...s,origin:t,originRect:i,guide:e.debug&&this.renderGuide(s)}));return a.forEach(t=>this.guides.push(t)),a},getTranslate(t,e="x"){let i=0;return(t||"").split(" ").forEach(t=>{const s=t.trim(),n=`translate${e.toUpperCase()}(`;0===s.indexOf(n)&&(i=parseFloat(s.replace(n,"")))}),i},setTranslate(t,e,i){const s=`translate${e.toUpperCase()}(`,n=`${s}${i})`;let o=(t||"").split(" ").map(t=>{return 0===t.trim().indexOf(s)&&(t=n),t}).join(" ");return o.indexOf(s)<0&&(o+=` ${n}`),o},getPosition(){const{target:t,isTran:e}=this,{left:i,top:s,transform:n}=t.getStyle();let o=0,r=0;return e?(o=this.getTranslate(n),r=this.getTranslate(n,"y")):(o=parseFloat(i),r=parseFloat(s)),{x:o,y:r}},setPosition({x:e,y:i,end:s,position:n,width:o,height:r}){const{target:a,isTran:d}=this,g=s?"":1,h=`${e}px`,l=`${i}px`;if(d){let t=a.getStyle().transform||"";return t=this.setTranslate(t,"x",h),t=this.setTranslate(t,"y",l),a.addStyle({transform:t,en:g},{avoidStore:!s})}const u={position:n,width:o,height:r},c={left:h,top:l,en:g};t.keys(u).forEach(t=>{const e=u[t];e&&(c[t]=e)}),a.addStyle(c,{avoidStore:!s})},_getDragData(){const{target:t}=this;return{target:t,parent:t.parent(),index:t.index()}},onStart(){const{target:t,editor:e,isTran:i,opts:s}=this,{center:n,onStart:o}=s,{Canvas:r}=e,a=t.getStyle();if(o&&o(this._getDragData()),!i&&"absolute"!==a.position){let{left:e,top:i,width:s,height:o}=r.offset(t.getEl());if(n){const{x:t,y:s}=r.getMouseRelativeCanvas(event);e=t,i=s}this.setPosition({x:e,y:i,width:`${s}px`,height:`${o}px`,position:"absolute"})}},onDrag(...t){const{guidesTarget:e,opts:i}=this,{onDrag:s}=i;this.updateGuides(e),i.debug&&e.forEach(t=>this.renderGuide(t)),i.guidesInfo&&this.renderGuideInfo(e.filter(t=>t.active)),s&&s(this._getDragData())},onEnd(t,e,i={}){const{editor:s,opts:n,id:o}=this,{onEnd:r}=n;r&&r(t,i,{event:t,...i,...this._getDragData()}),s.stopCommand(o),this.hideGuidesInfo(),this.em.trigger("dmode:end",this.getEventOpts())},hideGuidesInfo(){["X","Y"].forEach(t=>{const e=this[`elGuideInfo${t}`];e&&(e.style.display="none")})},renderGuideInfo(e=[]){const{guidesStatic:i}=this;this.hideGuidesInfo(),e.forEach(e=>{const{origin:s,x:n}=e,o=this.getElementPos(s),r=t.isUndefined(n)?"y":"x",a="y"===r,d=o[a?"left":"top"],g=o.rect[a?"left":"top"],h=a?d+o.width:d+o.height,l=a?g+o.rect.width:g+o.rect.height,u=this[`elGuideInfo${r.toUpperCase()}`],c=this[`elGuideInfoContent${r.toUpperCase()}`],p=u.style,f=i.filter(t=>t.type===e.type).map(t=>{const{left:e,width:i,top:s,height:n}=t.originRect,o=a?e+i:s+n;return{gap:o<d?d-o:(a?e:s)-h,guide:t}}).filter(t=>t.gap>0).sort((t,e)=>t.gap-e.gap).map(t=>t.guide)[0];if(f){const{left:t,width:s,top:n,height:r,rect:y}=f.originRect,m=a?t<o.left:n<o.top,x=a?t:n,E=a?y.left:y.top,G=a?t+s:n+r,$=a?y.left+y.width:y.top+y.height,v=a?e.y:e.x,S=m?G:h,C=`${v}px`,T=m?d-G:x-h,b=m?g-$:E-l;p.display="",p[a?"top":"left"]=C,p[a?"left":"top"]=`${S}px`,p[a?"width":"height"]=`${T}px`,c.innerHTML=`${Math.round(b)}px`,this.em.trigger("dmode:active",{...this.getEventOpts(),guide:e,guidesStatic:i,matched:f,posFirst:v,posSecond:S,size:T,sizeRaw:b,elGuideInfo:u,elGuideInfoCnt:c})}})},toggleDrag(t){const{ppfx:e,editor:i}=this,s=t?"add":"remove",n=[`${e}is__grabbing`],{Canvas:o}=i,r=o.getBody();n.forEach(t=>r.classList[s](t)),o[t?"startAutoscroll":"stopAutoscroll"]()}}});
//# sourceMappingURL=../../sourcemaps/commands/view/ComponentDrag.js.map
