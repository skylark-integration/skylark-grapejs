/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-backbone","skylark-underscore","./mixins"],function(e,t,i){"use strict";const s=e.$;return e.View.extend({initialize(e){this.opt=e||{},t.bindAll(this,"startSort","onMove","endMove","rollback","updateOffset","moveDragHelper");var i=e||{};this.elT=0,this.elL=0,this.borderOffset=i.borderOffset||10;var o=i.container;this.el="string"==typeof o?document.querySelector(o):o,this.$el=s(this.el),this.containerSel=i.containerSel||"div",this.itemSel=i.itemSel||"div",this.draggable=i.draggable||!0,this.nested=i.nested||0,this.pfx=i.pfx||"",this.ppfx=i.ppfx||"",this.freezeClass=i.freezeClass||this.pfx+"freezed",this.onStart=i.onStart||"",this.onEndMove=i.onEndMove||"",this.direction=i.direction||"v",this.onMoveClb=i.onMove||"",this.relative=i.relative||0,this.ignoreViewChildren=i.ignoreViewChildren||0,this.ignoreModels=i.ignoreModels||0,this.plh=i.placer||"",this.wmargin=i.wmargin||0,this.offTop=i.offsetTop||0,this.offLeft=i.offsetLeft||0,this.document=i.document||document,this.$document=s(this.document),this.dropContent=null,this.em=i.em||"",this.dragHelper=null,this.canvasRelative=i.canvasRelative||0,this.selectOnEnd=!i.avoidSelectOnEnd,this.scale=i.scale,this.activeTextModel=null,this.em&&this.em.undefined&&(this.em.undefined("change:canvasOffset",this.updateOffset),this.updateOffset())},getScale(){return t.result(this,scale)||1},getContainerEl(e){if(e&&(this.el=e),!this.el){var t=this.opt.container;this.el="string"==typeof t?document.querySelector(t):t,this.$el=s(this.el)}return this.el},getDocuments(e){const t=this.em,i=e?e.ownerDocument:t&&t.get("Canvas").getBody().ownerDocument,s=[document];return i&&s.push(i),s},updateOffset(){const e=this.em.get("canvasOffset")||{};this.offTop=e.top,this.offLeft=e.left},setDropContent(e){this.dropModel=null,this.dropContent=e},updateTextViewCursorPosition(e){const t=this.em.get("Canvas"),s=t.getDocument();let o=null;if(s.caretRangeFromPoint){const t=i.getPointerEvent(e);o=s.caretRangeFromPoint(t.clientX,t.clientY)}else e.rangeParent&&(o=s.createRange()).setStart(e.rangeParent,e.rangeOffset);const r=t.getWindow().getSelection();t.getFrameEl().focus(),r.removeAllRanges(),o&&r.addRange(o)},setContentEditable(e,t){if(e){const i=e.getEl();i.contentEditable!=t&&(i.contentEditable=t)}},toggleSortCursor(e){const{em:t}=this,i=t&&t.get("Canvas");i&&(e?i.startAutoscroll():i.stopAutoscroll())},setDragHelper(e,t){const i=t||"",o=e.cloneNode(1),r=e.getBoundingClientRect(),n=getComputedStyle(e);let l="";for(var a=0;a<n.length;a++){const e=n[a];l+=`${e}:${n.getPropertyValue(e)};`}document.body.appendChild(o),o.className+=` ${this.pfx}bdrag`,o.setAttribute("style",l),this.dragHelper=o,o.style.width=`${r.width}px`,o.style.height=`${r.height}px`,i&&this.moveDragHelper(i),this.em&&s(this.em.get("Canvas").getBody().ownerDocument).undefined("mousemove",this.moveDragHelper).undefined("mousemove",this.moveDragHelper),s(document).undefined("mousemove",this.moveDragHelper).undefined("mousemove",this.moveDragHelper)},moveDragHelper(e){const t=e.target.ownerDocument;if(!this.dragHelper||!t)return;let i=e.pageY,s=e.pageX,o=0,r=0;const n=(t.defaultView||t.parentWindow).frameElement,l=this.dragHelper.style;if(n){const t=n.getBoundingClientRect();o=t.top+document.documentElement.scrollTop,r=t.left+document.documentElement.scrollLeft,i=e.clientY,s=e.clientX}l.top=i+o+"px",l.left=s+r+"px"},matches:(e,t,s)=>i.matches.call(e,t),closest(e,t){if(e){for(var i=e.parentNode;i&&1===i.nodeType;){if(this.undefined(i,t))return i;i=i.parentNode}return null}},offset(e){var t=e.getBoundingClientRect();return{top:t.top+document.body.scrollTop,left:t.left+document.body.scrollLeft}},createPlaceholder(){var e=this.pfx,t=document.createElement("div"),i=document.createElement("div");return t.className=e+"placeholder",t.style.display="none",t.style["pointer-events"]="none",i.className=e+"placeholder-int",t.appendChild(i),t},startSort(e,t={}){const s=this.em,o=this.itemSel,r=this.containerSel,n=this.getContainerEl(t.container),l=this.getDocuments(e),a=this.onStart;let h,d=this.plh;this.dropModel=null,this.target=null,this.prevTarget=null,this.moved=0,e&&!this.undefined(e,`${o}, ${r}`)&&(e=this.closest(e,o)),this.eV=e,d||(d=this.createPlaceholder(),n.appendChild(d),this.plh=d),e&&((h=this.getSourceModel(e))&&h.set&&h.set("status","freezed"),this.srcModel=h),i.on(n,"mousemove dragover",this.onMove),i.on(l,"mouseup dragend touchend",this.endMove),i.on(l,"keydown",this.rollback),a&&a({target:h,parent:h&&h.parent(),index:h&&h.index()}),s&&s.clearSelection(),this.toggleSortCursor(1),s&&s.trigger("sorter:drag:start",e,h)},getTargetModel(e){let t=e||this.target;return s(t).data("model")},getSourceModel(e,{target:t,avoidChildren:i=1}={}){const{em:o,eV:r}=this,n=e||r;let{dropModel:l,dropContent:a}=this;const h=e=>e&&t&&e.opt&&e.opt.avoidChildren&&this.isTextableActive(e,t);if(a&&o){if(h(l)&&(l=null),!l){const e=o.get("DomComponents").getComponents(),s={avoidChildren:i,avoidStore:1,avoidUpdateStyle:1},r=e.add(a,langx.mixin({},s,{temporary:1}));if(l=(l=e.remove(r,s))instanceof Array?l[0]:l,this.dropModel=l,h(l))return this.getSourceModel(n,{target:t,avoidChildren:0})}return l}return n&&s(n).data("model")},selectTargetModel(t){if(t instanceof e.Collection)return;const{targetModel:i}=this;i&&i!==this.srcModel&&i.set("status",""),t&&t.set&&(t.set("status","selected-parent"),this.targetModel=t)},onMove(e){const i=e,{em:o,onMoveClb:r,plh:n}=this;this.moved=1;var l=n.style.display;l&&"none"!==l||(n.style.display="block");var a=this.offset(this.el);this.elT=this.wmargin?Math.abs(a.top):a.top,this.elL=this.wmargin?Math.abs(a.left):a.left;var h=e.pageY-this.elT+this.el.scrollTop,d=e.pageX-this.elL+this.el.scrollLeft;if(this.canvasRelative&&o){const t=o.get("Canvas").getMouseRelativeCanvas(e,{noScroll:1});d=t.x,h=t.y}this.rX=d,this.rY=h,this.eventMove=e;const c=this.getSourceModel(),g=this.dimsFromTarget(e.target,d,h),f=this.target,p=f&&this.getTargetModel(f);if(this.selectTargetModel(p),p||(n.style.display="none"),!f)return;this.lastDims=g;const m=this.findPosition(g,d,h);this.isTextableActive(c,p)?(this.activeTextModel=p,this.setContentEditable(p,!0),n.style.display="none",this.lastPos=m,this.updateTextViewCursorPosition(i)):(this.disableTextable(),this.activeTextModel=null,this.lastPos&&this.lastPos.index==m.index&&this.lastPos.method==m.method||(this.movePlaceholder(this.plh,g,m,this.prevTargetDim),this.$plh||(this.$plh=s(this.plh)),this.canvasRelative||(this.offTop&&this.$plh.css("top","+="+this.offTop+"px"),this.offLeft&&this.$plh.css("left","+="+this.offLeft+"px")),this.lastPos=m)),t.isFunction(r)&&r({event:e,target:c,parent:p,index:m.index+("after"==m.method?1:0)}),o&&o.trigger("sorter:drag",{target:f,targetModel:p,sourceModel:c,dims:g,pos:m,x:d,y:h})},isTextableActive:(e,t)=>e&&e.get&&e.get("textable")&&t&&t.is("text"),disableTextable(){const{activeTextModel:e}=this;e&&e.getView().disableEditing()},isInFlow(e,t){if(!e)return!1;t=t||document.body;var i=e;return i.offsetHeight,!!this.styleInFlow(i,t)},styleInFlow(e,t){if(i.isTextNode(e))return;const o=e.style||{},r=s(e),n=t&&s(t);if(!(o.overflow&&"visible"!==o.overflow||"none"!==r.css("float")||n&&"flex"==n.css("display")&&"column"!==n.css("flex-direction"))){switch(o.position){case"static":case"relative":case"":break;default:return}switch(e.tagName){case"TR":case"TBODY":case"THEAD":case"TFOOT":return!0}switch(r.css("display")){case"block":case"list-item":case"table":case"flex":return!0}}},validTarget(i,s){const o=this.getTargetModel(i),r=this.getSourceModel(s,{target:o});let n={valid:!0,src:s=r&&r.view&&r.view.el,srcModel:r,trg:i=o&&o.view&&o.view.el,trgModel:o};if(!s||!i)return n.valid=!1,n;let l=r.get("draggable");l=l instanceof Array?l.join(", "):l,n.dragInfo=l,l=t.isString(l)?this.undefined(i,l):l,n.draggable=l;let a=o.get("droppable");return a=(a=a instanceof e.Collection?1:a)instanceof Array?a.join(", "):a,n.dropInfo=a,a=t.isString(a)?this.undefined(s,a):a,a=l&&this.isTextableActive(r,o)?1:a,n.droppable=a,a&&l||(n.valid=!1),n},dimsFromTarget(e,t,i){const s=this.em;var o=[];if(!e)return o;if(this.undefined(e,`${this.itemSel}, ${this.containerSel}`)||(e=this.closest(e,this.itemSel)),this.draggable instanceof Array&&(e=this.closest(e,this.draggable.join(","))),!e)return o;if(this.prevTarget&&this.prevTarget!=e&&(this.prevTarget=null),!this.prevTarget){this.targetP=this.closest(e,this.containerSel);let o=this.validTarget(e);if(s&&s.trigger("sorter:drag:validation",o),!o.valid&&this.targetP)return this.dimsFromTarget(this.targetP,t,i);this.prevTarget=e,this.prevTargetDim=this.getDim(e),this.cacheDimsP=this.getChildrenDim(this.targetP),this.cacheDims=this.getChildrenDim(e)}if(this.prevTarget==e&&(o=this.cacheDims),this.target=this.prevTarget,this.nearBorders(this.prevTargetDim,t,i)||!this.nested&&!this.cacheDims.length){const e=this.targetP;e&&this.validTarget(e).valid&&(o=this.cacheDimsP,this.target=e)}return this.lastPos=null,o},getTargetFromEl(e){let t,i=e,s=this.targetPrev;const o=this.em,r=this.containerSel,n=this.itemSel;if(this.undefined(i,`${n}, ${r}`)||(i=this.closest(i,n)),this.draggable instanceof Array&&(i=this.closest(i,this.draggable.join(","))),s&&s!=i&&(this.targetPrev=""),!this.targetPrev){t=this.closest(i,r);const e=this.validTarget(i);if(o&&o.trigger("sorter:drag:validation",e),!e.valid&&t)return this.getTargetFromEl(t);this.targetPrev=i}return this.nearElBorders(i)&&(t=this.closest(i,r))&&this.validTarget(t).valid&&(i=t),i},nearElBorders(e){const t=e.getBoundingClientRect(),i=e.ownerDocument.body,{x:s,y:o}=this.getCurrentPos(),r=t.top+i.scrollTop,n=t.left+i.scrollLeft,l=t.width,a=t.height;if(o<r+10||o>r+a-10||s<n+10||s>n+l-10)return 1},getCurrentPos(){const e=this.eventMove;return{x:e.pageX||0,y:e.pageY||0}},getDim(e){const{em:t,canvasRelative:i}=this;var s,o,r,n;if(i&&t){const i=t.get("Canvas"),l=i.getElementPos(e,{noScroll:1}),a=i.getElementOffsets(e);s=l.top-a.marginTop,o=l.left-a.marginLeft,r=l.height+a.marginTop+a.marginBottom,n=l.width+a.marginLeft+a.marginRight}else{var l=this.offset(e);s=this.relative?e.offsetTop:l.top-(this.wmargin?-1:1)*this.elT,o=this.relative?e.offsetLeft:l.left-(this.wmargin?-1:1)*this.elL,r=e.offsetHeight,n=e.offsetWidth}return[s,o,r,n]},getChildrenDim(e){const o=[];if(!e)return o;const r=this.getTargetModel(e);if(r&&r.view&&!this.ignoreViewChildren){const t=r.getCurrentView?r.getCurrentView():r.view;e=t.getChildrenContainer()}return t.each(e.children,(t,r)=>{const n=i.getModel(t,s),l=n&&n.index?n.index():r;if(!i.isTextNode(t)&&!this.undefined(t,this.itemSel))return;const a=this.getDim(t);let h=this.direction;h="v"==h||"h"!=h&&this.isInFlow(t,e),a.push(h,t,l),o.push(a)}),o},nearBorders(e,t,i){var s=0,o=this.borderOffset,r=t||0,n=i||0,l=e[0],a=e[1],h=e[2],d=e[3];return(l+o>n||n>l+h-o||a+o>r||r>a+d-o)&&(s=1),!!s},findPosition(e,t,i){for(var s={index:0,indexEl:0,method:"before"},o=0,r=0,n=0,l=0,a=0,h=0,d=0,c=0,g=0,f=e.length;g<f;g++)if(n=(c=e[g])[1]+c[3],d=c[0]+c[2],a=c[1]+c[3]/2,h=c[0]+c[2]/2,!(r&&c[1]>r||l&&h>=l||o&&n<o))if(s.index=g,s.indexEl=c[6],c[4]){if(i<h){s.method="before";break}s.method="after"}else i<d&&(l=d),t<a?(r=a,s.method="before"):(o=a,s.method="after");return s},movePlaceholder(e,t,i,s){var o=0,r=0,n=0,l=0,a="px",h=i.method,d=t[i.index];if(e.style.borderColor="transparent #62c462",e.style.borderWidth="3px 5px",e.style.margin="-3px 0 0",d)d[4]?(n=d[3]+a,l="auto",o="before"==h?d[0]-0:d[0]+d[2]-0,r=d[1]):(n="auto",l=d[2]-0+a,o=d[0]+0,r="before"==h?d[1]-0:d[1]+d[3]-0,e.style.borderColor="#62c462 transparent",e.style.borderWidth="5px 3px",e.style.margin="0 0 0 -3px");else{if(!this.nested)return void(e.style.display="none");s&&(o=s[0]+5,r=s[1]+5,n=parseInt(s[3])-10+a,l="auto")}e.style.top=o+a,e.style.left=r+a,n&&(e.style.width=n),l&&(e.style.height=l)},endMove(e){const s=this.eV,o=[],r=this.getDocuments(),n=this.getContainerEl(),l=this.onEndMove,{target:a,lastPos:h}=this;let d;if(i.off(n,"mousemove dragover",this.onMove),i.off(r,"mouseup dragend touchend",this.endMove),i.off(r,"keydown",this.rollback),this.plh.style.display="none",s&&(d=this.getSourceModel(),this.selectOnEnd&&d&&d.set&&(d.set("status",""),d.set("status","selected"))),this.moved){const e=this.toMove;(t.isArray(e)?e:e?[e]:[s]).forEach(e=>{o.push(this.move(a,e,h))})}this.plh&&(this.plh.style.display="none");var c=this.dragHelper;if(c&&(c.parentNode.removeChild(c),this.dragHelper=null),this.disableTextable(),this.selectTargetModel(),this.toggleSortCursor(),this.toMove=null,t.isFunction(l)){const e={target:d,parent:d&&d.parent(),index:d&&d.index()};o.length?o.forEach(t=>l(t,this,e)):l(null,this,langx.mixin({},e,{cancelled:1}))}},move(t,o,r){const{em:n,activeTextModel:l,dropContent:a}=this,h=i.getElement(o);n&&n.trigger("component:dragEnd:before",t,h,r);var d,c,g,f=[],p=r.indexEl,m=this.validTarget(t,h),u=s(t).data("collection"),v=m.srcModel,T=m.droppable,b=m.draggable,y=m.dropInfo,x=m.dragInfo;const{trgModel:C}=m;T=C instanceof e.Collection?1:T;const M=this.isTextableActive(v,C);if(u&&T&&b){var w={at:p="after"===r.method?p+1:p,noIncrement:1};if(a?(d=a,w.silent=!1,w.avoidUpdateStyle=1):(w.temporary=1,c=u.add({},langx.mixin({},w)),v.collection&&(d=v.collection.remove(v,{temporary:1}))),M){const e=l.getView();l.trigger("active");const{activeRte:t}=e,i=v.getEl();delete v.opt.temporary,v.getView().render(),i.setAttribute("data-gjs-textable","true");const{outerHTML:s}=i;t.insertHTML&&t.insertHTML(s)}else g=u.add(d,w);a?this.dropContent=null:u.remove(c),this.prevTarget=null}else u||f.push("Target collection not found"),T||f.push(`Target is not droppable, accepts [${y}]`),b||f.push(`Component not draggable, acceptable by [${x}]`),console.warn("Invalid target position: "+f.join(", "));return n&&n.trigger("component:dragEnd",u,d,f),n&&n.trigger("sorter:drag:end",{targetCollection:u,modelToDrop:d,warns:f,validResult:m,dst:t,srcEl:h}),g},rollback(e){i.off(this.getDocuments(),"keydown",this.rollback),27==(e.which||e.keyCode)&&(this.moved=0,this.endMove())}})});
//# sourceMappingURL=../sourcemaps/utils/Sorter.js.map
