/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-backbone","skylark-underscore","./mixins"],function(e,t,s){"use strict";const i=e.$;return e.View.extend({initialize(e){this.opt=e||{},t.bindAll(this,"startSort","onMove","endMove","rollback","updateOffset","moveDragHelper");var s=e||{};this.elT=0,this.elL=0,this.borderOffset=s.borderOffset||10;var o=s.container;this.el="string"==typeof o?document.querySelector(o):o,this.$el=i(this.el),this.containerSel=s.containerSel||"div",this.itemSel=s.itemSel||"div",this.draggable=s.draggable||!0,this.nested=s.nested||0,this.pfx=s.pfx||"",this.ppfx=s.ppfx||"",this.freezeClass=s.freezeClass||this.pfx+"freezed",this.onStart=s.onStart||"",this.onEndMove=s.onEndMove||"",this.direction=s.direction||"v",this.onMoveClb=s.onMove||"",this.relative=s.relative||0,this.ignoreViewChildren=s.ignoreViewChildren||0,this.ignoreModels=s.ignoreModels||0,this.plh=s.placer||"",this.wmargin=s.wmargin||0,this.offTop=s.offsetTop||0,this.offLeft=s.offsetLeft||0,this.document=s.document||document,this.$document=i(this.document),this.dropContent=null,this.em=s.em||"",this.dragHelper=null,this.canvasRelative=s.canvasRelative||0,this.selectOnEnd=!s.avoidSelectOnEnd,this.scale=s.scale,this.activeTextModel=null,this.em&&this.em.on&&(this.em.on("change:canvasOffset",this.updateOffset),this.updateOffset())},getScale(){return t.result(this,scale)||1},getContainerEl(e){if(e&&(this.el=e),!this.el){var t=this.opt.container;this.el="string"==typeof t?document.querySelector(t):t,this.$el=i(this.el)}return this.el},getDocuments(e){const t=this.em,s=e?e.ownerDocument:t&&t.get("Canvas").getBody().ownerDocument,i=[document];return s&&i.push(s),i},updateOffset(){const e=this.em.get("canvasOffset")||{};this.offTop=e.top,this.offLeft=e.left},setDropContent(e){this.dropModel=null,this.dropContent=e},updateTextViewCursorPosition(e){const t=this.em.get("Canvas"),i=t.getDocument();let o=null;if(i.caretRangeFromPoint){const t=s.getPointerEvent(e);o=i.caretRangeFromPoint(t.clientX,t.clientY)}else e.rangeParent&&(o=i.createRange()).setStart(e.rangeParent,e.rangeOffset);const r=t.getWindow().getSelection();t.getFrameEl().focus(),r.removeAllRanges(),o&&r.addRange(o)},setContentEditable(e,t){if(e){const s=e.getEl();s.contentEditable!=t&&(s.contentEditable=t)}},toggleSortCursor(e){const{em:t}=this,s=t&&t.get("Canvas");s&&(e?s.startAutoscroll():s.stopAutoscroll())},setDragHelper(e,t){const s=t||"",o=e.cloneNode(1),r=e.getBoundingClientRect(),n=getComputedStyle(e);let l="";for(var a=0;a<n.length;a++){const e=n[a];l+=`${e}:${n.getPropertyValue(e)};`}document.body.appendChild(o),o.className+=` ${this.pfx}bdrag`,o.setAttribute("style",l),this.dragHelper=o,o.style.width=`${r.width}px`,o.style.height=`${r.height}px`,s&&this.moveDragHelper(s),this.em&&i(this.em.get("Canvas").getBody().ownerDocument).on("mousemove",this.moveDragHelper).on("mousemove",this.moveDragHelper),i(document).on("mousemove",this.moveDragHelper).on("mousemove",this.moveDragHelper)},moveDragHelper(e){const t=e.target.ownerDocument;if(!this.dragHelper||!t)return;let s=e.pageY,i=e.pageX,o=0,r=0;const n=(t.defaultView||t.parentWindow).frameElement,l=this.dragHelper.style;if(n){const t=n.getBoundingClientRect();o=t.top+document.documentElement.scrollTop,r=t.left+document.documentElement.scrollLeft,s=e.clientY,i=e.clientX}l.top=s+o+"px",l.left=i+r+"px"},matches:(e,t,i)=>s.matches.call(e,t),closest(e,t){if(e){for(var s=e.parentNode;s&&1===s.nodeType;){if(this.matches(s,t))return s;s=s.parentNode}return null}},offset(e){var t=e.getBoundingClientRect();return{top:t.top+document.body.scrollTop,left:t.left+document.body.scrollLeft}},createPlaceholder(){var e=this.pfx,t=document.createElement("div"),s=document.createElement("div");return t.className=e+"placeholder",t.style.display="none",t.style["pointer-events"]="none",s.className=e+"placeholder-int",t.appendChild(s),t},startSort(e,t={}){const i=this.em,o=this.itemSel,r=this.containerSel,n=this.getContainerEl(t.container),l=this.getDocuments(e),a=this.onStart;let h,d=this.plh;this.dropModel=null,this.target=null,this.prevTarget=null,this.moved=0,e&&!this.matches(e,`${o}, ${r}`)&&(e=this.closest(e,o)),this.eV=e,d||(d=this.createPlaceholder(),n.appendChild(d),this.plh=d),e&&((h=this.getSourceModel(e))&&h.set&&h.set("status","freezed"),this.srcModel=h),s.on(n,"mousemove dragover",this.onMove),s.on(l,"mouseup dragend touchend",this.endMove),s.on(l,"keydown",this.rollback),a&&a({target:h,parent:h&&h.parent(),index:h&&h.index()}),i&&i.clearSelection(),this.toggleSortCursor(1),i&&i.trigger("sorter:drag:start",e,h)},getTargetModel(e){let t=e||this.target;return i(t).data("model")},getSourceModel(e,{target:t,avoidChildren:s=1}={}){const{em:o,eV:r}=this,n=e||r;let{dropModel:l,dropContent:a}=this;const h=e=>e&&t&&e.opt&&e.opt.avoidChildren&&this.isTextableActive(e,t);if(a&&o){if(h(l)&&(l=null),!l){const e=o.get("DomComponents").getComponents(),i={avoidChildren:s,avoidStore:1,avoidUpdateStyle:1},r=e.add(a,{...i,temporary:1});if(l=(l=e.remove(r,i))instanceof Array?l[0]:l,this.dropModel=l,h(l))return this.getSourceModel(n,{target:t,avoidChildren:0})}return l}return n&&i(n).data("model")},selectTargetModel(t){if(t instanceof e.Collection)return;const{targetModel:s}=this;s&&s!==this.srcModel&&s.set("status",""),t&&t.set&&(t.set("status","selected-parent"),this.targetModel=t)},onMove(e){const s=e,{em:o,onMoveClb:r,plh:n}=this;this.moved=1;var l=n.style.display;l&&"none"!==l||(n.style.display="block");var a=this.offset(this.el);this.elT=this.wmargin?Math.abs(a.top):a.top,this.elL=this.wmargin?Math.abs(a.left):a.left;var h=e.pageY-this.elT+this.el.scrollTop,d=e.pageX-this.elL+this.el.scrollLeft;if(this.canvasRelative&&o){const t=o.get("Canvas").getMouseRelativeCanvas(e,{noScroll:1});d=t.x,h=t.y}this.rX=d,this.rY=h,this.eventMove=e;const c=this.getSourceModel(),g=this.dimsFromTarget(e.target,d,h),p=this.target,f=p&&this.getTargetModel(p);if(this.selectTargetModel(f),f||(n.style.display="none"),!p)return;this.lastDims=g;const m=this.findPosition(g,d,h);this.isTextableActive(c,f)?(this.activeTextModel=f,this.setContentEditable(f,!0),n.style.display="none",this.lastPos=m,this.updateTextViewCursorPosition(s)):(this.disableTextable(),this.activeTextModel=null,this.lastPos&&this.lastPos.index==m.index&&this.lastPos.method==m.method||(this.movePlaceholder(this.plh,g,m,this.prevTargetDim),this.$plh||(this.$plh=i(this.plh)),this.canvasRelative||(this.offTop&&this.$plh.css("top","+="+this.offTop+"px"),this.offLeft&&this.$plh.css("left","+="+this.offLeft+"px")),this.lastPos=m)),t.isFunction(r)&&r({event:e,target:c,parent:f,index:m.index+("after"==m.method?1:0)}),o&&o.trigger("sorter:drag",{target:p,targetModel:f,sourceModel:c,dims:g,pos:m,x:d,y:h})},isTextableActive:(e,t)=>e&&e.get&&e.get("textable")&&t&&t.is("text"),disableTextable(){const{activeTextModel:e}=this;e&&e.getView().disableEditing()},isInFlow(e,t){if(!e)return!1;t=t||document.body;var s=e;return s.offsetHeight,!!this.styleInFlow(s,t)},styleInFlow(e,t){if(s.isTextNode(e))return;const o=e.style||{},r=i(e),n=t&&i(t);if(!(o.overflow&&"visible"!==o.overflow||"none"!==r.css("float")||n&&"flex"==n.css("display")&&"column"!==n.css("flex-direction"))){switch(o.position){case"static":case"relative":case"":break;default:return}switch(e.tagName){case"TR":case"TBODY":case"THEAD":case"TFOOT":return!0}switch(r.css("display")){case"block":case"list-item":case"table":case"flex":return!0}}},validTarget(s,i){const o=this.getTargetModel(s),r=this.getSourceModel(i,{target:o});let n={valid:!0,src:i=r&&r.view&&r.view.el,srcModel:r,trg:s=o&&o.view&&o.view.el,trgModel:o};if(!i||!s)return n.valid=!1,n;let l=r.get("draggable");l=l instanceof Array?l.join(", "):l,n.dragInfo=l,l=t.isString(l)?this.matches(s,l):l,n.draggable=l;let a=o.get("droppable");return a=(a=a instanceof e.Collection?1:a)instanceof Array?a.join(", "):a,n.dropInfo=a,a=t.isString(a)?this.matches(i,a):a,a=l&&this.isTextableActive(r,o)?1:a,n.droppable=a,a&&l||(n.valid=!1),n},dimsFromTarget(e,t,s){const i=this.em;var o=[];if(!e)return o;if(this.matches(e,`${this.itemSel}, ${this.containerSel}`)||(e=this.closest(e,this.itemSel)),this.draggable instanceof Array&&(e=this.closest(e,this.draggable.join(","))),!e)return o;if(this.prevTarget&&this.prevTarget!=e&&(this.prevTarget=null),!this.prevTarget){this.targetP=this.closest(e,this.containerSel);let o=this.validTarget(e);if(i&&i.trigger("sorter:drag:validation",o),!o.valid&&this.targetP)return this.dimsFromTarget(this.targetP,t,s);this.prevTarget=e,this.prevTargetDim=this.getDim(e),this.cacheDimsP=this.getChildrenDim(this.targetP),this.cacheDims=this.getChildrenDim(e)}if(this.prevTarget==e&&(o=this.cacheDims),this.target=this.prevTarget,this.nearBorders(this.prevTargetDim,t,s)||!this.nested&&!this.cacheDims.length){const e=this.targetP;e&&this.validTarget(e).valid&&(o=this.cacheDimsP,this.target=e)}return this.lastPos=null,o},getTargetFromEl(e){let t,s=e,i=this.targetPrev;const o=this.em,r=this.containerSel,n=this.itemSel;if(this.matches(s,`${n}, ${r}`)||(s=this.closest(s,n)),this.draggable instanceof Array&&(s=this.closest(s,this.draggable.join(","))),i&&i!=s&&(this.targetPrev=""),!this.targetPrev){t=this.closest(s,r);const e=this.validTarget(s);if(o&&o.trigger("sorter:drag:validation",e),!e.valid&&t)return this.getTargetFromEl(t);this.targetPrev=s}return this.nearElBorders(s)&&(t=this.closest(s,r))&&this.validTarget(t).valid&&(s=t),s},nearElBorders(e){const t=e.getBoundingClientRect(),s=e.ownerDocument.body,{x:i,y:o}=this.getCurrentPos(),r=t.top+s.scrollTop,n=t.left+s.scrollLeft,l=t.width,a=t.height;if(o<r+10||o>r+a-10||i<n+10||i>n+l-10)return 1},getCurrentPos(){const e=this.eventMove;return{x:e.pageX||0,y:e.pageY||0}},getDim(e){const{em:t,canvasRelative:s}=this;var i,o,r,n;if(s&&t){const s=t.get("Canvas"),l=s.getElementPos(e,{noScroll:1}),a=s.getElementOffsets(e);i=l.top-a.marginTop,o=l.left-a.marginLeft,r=l.height+a.marginTop+a.marginBottom,n=l.width+a.marginLeft+a.marginRight}else{var l=this.offset(e);i=this.relative?e.offsetTop:l.top-(this.wmargin?-1:1)*this.elT,o=this.relative?e.offsetLeft:l.left-(this.wmargin?-1:1)*this.elL,r=e.offsetHeight,n=e.offsetWidth}return[i,o,r,n]},getChildrenDim(e){const o=[];if(!e)return o;const r=this.getTargetModel(e);if(r&&r.view&&!this.ignoreViewChildren){const t=r.getCurrentView?r.getCurrentView():r.view;e=t.getChildrenContainer()}return t.each(e.children,(t,r)=>{const n=s.getModel(t,i),l=n&&n.index?n.index():r;if(!s.isTextNode(t)&&!this.matches(t,this.itemSel))return;const a=this.getDim(t);let h=this.direction;h="v"==h||"h"!=h&&this.isInFlow(t,e),a.push(h,t,l),o.push(a)}),o},nearBorders(e,t,s){var i=0,o=this.borderOffset,r=t||0,n=s||0,l=e[0],a=e[1],h=e[2],d=e[3];return(l+o>n||n>l+h-o||a+o>r||r>a+d-o)&&(i=1),!!i},findPosition(e,t,s){for(var i={index:0,indexEl:0,method:"before"},o=0,r=0,n=0,l=0,a=0,h=0,d=0,c=0,g=0,p=e.length;g<p;g++)if(n=(c=e[g])[1]+c[3],d=c[0]+c[2],a=c[1]+c[3]/2,h=c[0]+c[2]/2,!(r&&c[1]>r||l&&h>=l||o&&n<o))if(i.index=g,i.indexEl=c[6],c[4]){if(s<h){i.method="before";break}i.method="after"}else s<d&&(l=d),t<a?(r=a,i.method="before"):(o=a,i.method="after");return i},movePlaceholder(e,t,s,i){var o=0,r=0,n=0,l=0,a="px",h=s.method,d=t[s.index];if(e.style.borderColor="transparent #62c462",e.style.borderWidth="3px 5px",e.style.margin="-3px 0 0",d)d[4]?(n=d[3]+a,l="auto",o="before"==h?d[0]-0:d[0]+d[2]-0,r=d[1]):(n="auto",l=d[2]-0+a,o=d[0]+0,r="before"==h?d[1]-0:d[1]+d[3]-0,e.style.borderColor="#62c462 transparent",e.style.borderWidth="5px 3px",e.style.margin="0 0 0 -3px");else{if(!this.nested)return void(e.style.display="none");i&&(o=i[0]+5,r=i[1]+5,n=parseInt(i[3])-10+a,l="auto")}e.style.top=o+a,e.style.left=r+a,n&&(e.style.width=n),l&&(e.style.height=l)},endMove(e){const i=this.eV,o=[],r=this.getDocuments(),n=this.getContainerEl(),l=this.onEndMove,{target:a,lastPos:h}=this;let d;if(s.off(n,"mousemove dragover",this.onMove),s.off(r,"mouseup dragend touchend",this.endMove),s.off(r,"keydown",this.rollback),this.plh.style.display="none",i&&(d=this.getSourceModel(),this.selectOnEnd&&d&&d.set&&(d.set("status",""),d.set("status","selected"))),this.moved){const e=this.toMove;(t.isArray(e)?e:e?[e]:[i]).forEach(e=>{o.push(this.move(a,e,h))})}this.plh&&(this.plh.style.display="none");var c=this.dragHelper;if(c&&(c.parentNode.removeChild(c),this.dragHelper=null),this.disableTextable(),this.selectTargetModel(),this.toggleSortCursor(),this.toMove=null,t.isFunction(l)){const e={target:d,parent:d&&d.parent(),index:d&&d.index()};o.length?o.forEach(t=>l(t,this,e)):l(null,this,{...e,cancelled:1})}},move(t,o,r){const{em:n,activeTextModel:l,dropContent:a}=this,h=s.getElement(o);n&&n.trigger("component:dragEnd:before",t,h,r);var d,c,g,p=[],f=r.indexEl,m=this.validTarget(t,h),v=i(t).data("collection"),u=m.srcModel,T=m.droppable,b=m.draggable,y=m.dropInfo,x=m.dragInfo;const{trgModel:C}=m;T=C instanceof e.Collection?1:T;const M=this.isTextableActive(u,C);if(v&&T&&b){var w={at:f="after"===r.method?f+1:f,noIncrement:1};if(a?(d=a,w.silent=!1,w.avoidUpdateStyle=1):(w.temporary=1,c=v.add({},{...w}),u.collection&&(d=u.collection.remove(u,{temporary:1}))),M){const e=l.getView();l.trigger("active");const{activeRte:t}=e,s=u.getEl();delete u.opt.temporary,u.getView().render(),s.setAttribute("data-gjs-textable","true");const{outerHTML:i}=s;t.insertHTML&&t.insertHTML(i)}else g=v.add(d,w);a?this.dropContent=null:v.remove(c),this.prevTarget=null}else v||p.push("Target collection not found"),T||p.push(`Target is not droppable, accepts [${y}]`),b||p.push(`Component not draggable, acceptable by [${x}]`),console.warn("Invalid target position: "+p.join(", "));return n&&n.trigger("component:dragEnd",v,d,p),n&&n.trigger("sorter:drag:end",{targetCollection:v,modelToDrop:d,warns:p,validResult:m,dst:t,srcEl:h}),g},rollback(e){s.off(this.getDocuments(),"keydown",this.rollback),27==(e.which||e.keyCode)&&(this.moved=0,this.endMove())}})});
//# sourceMappingURL=../sourcemaps/utils/Sorter.js.map
