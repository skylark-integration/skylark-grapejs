/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-backbone","skylark-underscore","./config/config","./model/Component","./model/Components","./view/ComponentView","./view/ComponentsView","./model/ComponentTableCell","./view/ComponentTableCellView","./model/ComponentTableRow","./view/ComponentTableRowView","./model/ComponentTable","./view/ComponentTableView","./model/ComponentTableHead","./view/ComponentTableHeadView","./model/ComponentTableBody","./view/ComponentTableBodyView","./model/ComponentTableFoot","./view/ComponentTableFootView","./model/ComponentMap","./view/ComponentMapView","./model/ComponentLink","./view/ComponentLinkView","./model/ComponentLabel","./view/ComponentLabelView","./model/ComponentVideo","./view/ComponentVideoView","./model/ComponentImage","./view/ComponentImageView","./model/ComponentScript","./view/ComponentScriptView","./model/ComponentSvg","./model/ComponentSvgIn","./view/ComponentSvgView","./model/ComponentComment","./view/ComponentCommentView","./model/ComponentTextNode","./view/ComponentTextNodeView","./model/ComponentText","./view/ComponentTextView","./model/ComponentWrapper"],function(e,o,t,n,i,s,m,d,p,a,r,l,c,h,g,v,w,C,f,u,y,b,T,V,x,S,H,L,k,O,E,R,W,M,j,N,A,F,I,P,U){"use strict";return()=>{var B={};let J;var K,D,$=[{id:"cell",model:d,view:p},{id:"row",model:a,view:r},{id:"table",model:l,view:c},{id:"thead",model:h,view:g},{id:"tbody",model:v,view:w},{id:"tfoot",model:C,view:f},{id:"map",model:u,view:y},{id:"link",model:b,view:T},{id:"label",model:V,view:x},{id:"video",model:S,view:H},{id:"image",model:L,view:k},{id:"script",model:O,view:E},{id:"svg-in",model:W,view:M},{id:"svg",model:R,view:M},{id:"comment",model:j,view:N},{id:"textnode",model:A,view:F},{id:"text",model:I,view:P},{id:"wrapper",model:U,view:s},{id:"default",model:n,view:s}];return{Component:n,Components:i,ComponentsView:m,componentTypes:$,componentsById:{},name:"DomComponents",getConfig:()=>B,storageKey(){var e=[],o=B.stm&&B.stm.getConfig()||{};return o.storeHtml&&e.push("html"),o.storeComponents&&e.push("components"),e},init(e){for(var o in J=(B=e||{}).em,this.em=J,J&&(B.components=J.config.components||B.components),t)o in B||(B[o]=t[o]);var i=B.pStylePrefix;if(i&&(B.stylePrefix=i+B.stylePrefix),J){B.modal=J.get("Modal")||"",B.am=J.get("AssetManager")||"",J.get("Parser").compTypes=$,J.on("change:componentHovered",this.componentHovered,this);const e=J.get("selected");J.listenTo(e,"add",(e,o,t)=>this.selectAdd(e,t)),J.listenTo(e,"remove",(e,o,t)=>this.selectRemove(e,t))}let m=B.components,d={...B.wrapper};return d["custom-name"]=B.wrapperName,d.wrapper=1,d.type="wrapper",m&&m.constructor===Object&&m.wrapper&&(d={...m},m=m.components||[],d.components=[],J&&(J.config.components=m,B.components=m)),(K=new n(d,{em:J,config:B,componentTypes:$,domc:this})).set({attributes:{id:"wrapper"}}),D=new s({model:K,config:B,componentTypes:$}),this},onLoad(){this.setComponents(B.components)},postLoad(e){this.handleChanges(this.getWrapper(),null,{avoidStore:1})},handleChanges(e,o,t={}){const n=e.components(),i=J.get("UndoManager"),s=J.handleUpdates.bind(J),m=this.handleChanges.bind(this),d=this.handleChangesColl.bind(this),p=this.handleRemoves.bind(this);i&&i.add(e),i&&n&&i.add(n);[[e,"change:style change:content change:attributes change:src",s],[e,"change:components",d],[n,"add",m],[n,"remove",p],[e.get("classes"),"add remove",s]].forEach(e=>{J.stopListening(e[0],e[1],e[2]),J.listenTo(e[0],e[1],e[2])}),!t.avoidStore&&s("","",t),n.each(e=>this.handleChanges(e,o,t))},handleChangesColl(o,t){const n=J.get("UndoManager");if(n&&t instanceof e.Collection){const e=this.handleChanges.bind(this),o=this.handleRemoves.bind(this);n.add(t),[[t,"add",e],[t,"remove",o]].forEach(e=>{J.stopListening(e[0],e[1],e[2]),J.listenTo(e[0],e[1],e[2])})}},handleRemoves(e,o,t={}){!t.avoidStore&&J.handleUpdates(e,o,t)},load(e=""){const{em:t}=this;let n="";!e&&B.stm&&(e=B.em.getCacheLoad());const{components:i,html:s}=e;if(i)if(o.isObject(i)||o.isArray(i))n=i;else try{n=JSON.parse(i)}catch(e){t&&t.logError(e)}else s&&(n=s);const m=n&&n.constructor===Object;return(n&&n.length||m)&&(this.clear(),m?this.getWrapper().set(n):this.getComponents().add(n)),n},store(e){if(B.stm){var o={},t=this.storageKey();if(t.indexOf("html")>=0&&(o.html=B.em.getHtml()),t.indexOf("components")>=0){const{em:e}=this,t=B.storeWrapper?this.getWrapper():this.getComponents();o.components=JSON.stringify(t)}return e||B.stm.store(o),o}},getComponent:()=>K,getWrapper(){return this.getComponent()},getComponents(){return this.getWrapper().get("components")},addComponent(e){return this.getComponents().add(e)},render:()=>D.render().el,clear(){return this.getComponents().map(e=>e).forEach(e=>e.remove()),this},setComponents(e){this.clear().addComponent(e)},addType(e,t){const{em:n}=this,{model:i={},view:s={},isComponent:m,extend:d,extendView:p,extendFn:a=[],extendFnView:r=[]}=t,l=this.getType(e),c=this.getType(d),h=this.getType(p),g=c||(l||this.getType("default")),v=g.model,w=h?h.view:g.view,C=(e,o,t)=>e.reduce((e,n)=>{const i=o[n],s=t.prototype[n];return i&&s&&(e[n]=function(...e){s.bind(this)(...e),i.bind(this)(...e)}),e},{});"object"==typeof i&&(t.model=v.extend({...i,...C(a,i,v),defaults:langx.mixin({},v.prototype.defaults,o.result(i,"defaults"))},{isComponent:!l||c||m?m||(()=>0):v.isComponent})),"object"==typeof s&&(t.view=w.extend(langx.mixin({},s,C(r,s,w)))),l?(l.model=t.model,l.view=t.view):(t.id=e,$.unshift(t));const f=`component:type:${l?"update":"add"}`;return n&&n.trigger(f,l||t),this},getType(e){for(var o=$,t=0;t<o.length;t++){if(o[t].id==e)return o[t]}},removeType(e){const o=$,t=this.getType(e);if(!t)return;const n=o.indexOf(t);return o.splice(n,1),t},getTypes:()=>$,selectAdd(e,o={}){e&&(e.set({status:"selected"}),["component:selected","component:toggled"].forEach(t=>this.em.trigger(t,e,o)))},selectRemove(e,o={}){if(e){const{em:t}=this;e.set({status:"",state:""}),["component:deselected","component:toggled"].forEach(t=>this.em.trigger(t,e,o))}},componentHovered(){const e=B.em,t=e.get("componentHovered"),n=e.previous("componentHovered");n&&"hovered"==n.get("status")&&n.set({status:"",state:""}),t&&o.isEmpty(t.get("status"))&&t.set("status","hovered")}}}});
//# sourceMappingURL=../sourcemaps/dom_components/index.js.map
