/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-backbone","skylark-underscore","../model/Components","./ComponentsView","../../selector_manager/model/Selectors","../../utils/dom","../../utils/mixins"],function(t,e,s,i,n,o,l){"use strict";var a=t.View.extend({className(){return this.getClasses()},tagName(){return this.model.get("tagName")},initialize(t={}){const e=this.model,s=t.config||{},i=s.em,n=e.opt||{},{$el:o,el:a}=this,{draggableComponents:h}=s;this.opts=t,this.modelOpt=n,this.config=s,this.em=i||"",this.pfx=s.stylePrefix||"",this.ppfx=s.pStylePrefix||"",this.attr=e.get("attributes"),this.classe=this.attr.class||[],this.listenTo(e,"change:style",this.updateStyle),this.listenTo(e,"change:attributes change:_innertext",this.renderAttributes),this.listenTo(e,"change:highlightable",this.updateHighlight),this.listenTo(e,"change:status",this.updateStatus),this.listenTo(e,"change:script",this.reset),this.listenTo(e,"change:content",this.updateContent),this.listenTo(e,"change",this.handleChange),this.listenTo(e,"active",this.onActive),this.listenTo(e,"disable",this.onDisable),o.data("model",e),l.setViewEl(a,this),e.view=this,this._getFrame()&&e.views.push(this),this.initClasses(),this.initComponents({avoidRender:1}),this.events={...this.events,...h&&{dragstart:"handleDragStart"}},this.delegateEvents(),!n.temporary&&this.init(this._clbObj())},_clbObj(){const{em:t,model:e,el:s}=this;return{editor:t&&t.getEditor(),model:e,el:s}},init(){},removed(){},onActive(){},onDisable(){},remove(){t.View.prototype.remove.apply(this,arguments);const{model:e}=this,s=(this._getFrame()||{}).model;e.components().forEach(t=>{const e=t.getView(s);e&&e.remove()});const{views:i}=e;return i.splice(i.indexOf(this),1),this.removed(this._clbObj()),this},handleDragStart(t){t.preventDefault(),t.stopPropagation(),this.em.get("Commands").run("tlb-move",{target:this.model,event:t})},initClasses(){const{model:t}=this,e=t.get("classes");e instanceof n&&(this.stopListening(t,"change:classes",this.initClasses),this.listenTo(t,"change:classes",this.initClasses),this.listenTo(e,"add remove change",this.updateClasses),e.length&&this.importClasses())},initComponents(t={}){const{model:e,$el:i,childrenView:n}=this,o=e.get("components"),l=[e,"change:components",this.initComponents];o instanceof s&&(i.data("collection",o),n&&n.remove(),this.stopListening(...l),!t.avoidRender&&this.renderChildren(),this.listenTo(...l))},handleChange(){const{model:t}=this,s=e.keys(t.changed);if(1!==s.length||"status"!==s[0]){t.emitUpdate();for(let e in t.changed)t.emitUpdate(e)}},importClasses(){var t=this.config.em.get("SelectorManager");t&&this.model.get("classes").each(e=>{t.add(e.get("name"))})},updateStatus(t={}){this.em;const e=this.el,s=this.model.get("status"),i=(this.pfx,this.ppfx),n=`${i}selected`,o=`${n}-parent`,l=`${i}freezed`,a=`${i}hovered`,h=[n,o,l,a];this.$el.removeClass(h.join(" "));var r=e.getAttribute("class")||"",c="";switch(s){case"selected":c=`${r} ${n}`;break;case"selected-parent":c=`${r} ${o}`;break;case"freezed":c=`${r} ${l}`;break;case"freezed-selected":c=`${r} ${l} ${n}`;break;case"hovered":c=t.avoidHover?"":`${r} ${a}`}(c=c.trim())&&e.setAttribute("class",c)},updateHighlight(){const t=this.model.get("highlightable");this.setAttribute("data-highlightable",t?1:"")},updateStyle(){const{model:t,em:s,el:i}=this;if(s&&s.getConfig("avoidInlineStyle")){t.get("_innertext")?i.removeAttribute("id"):i.id=t.getId();const s=t.getStyle();!e.isEmpty(s)&&t.setStyle(s)}else this.setAttribute("style",t.styleToString())},updateClasses(){const t=this.model.get("classes").pluck("name").join(" ");this.setAttribute("class",t),this.updateStatus()},setAttribute(t,e){const s=this.$el;e?s.attr(t,e):s.removeAttr(t)},getClasses(){return this.model.getClasses().join(" ")},updateAttributes(){const t=[],{model:s,$el:i,el:n,config:o}=this,{highlightable:l,textable:a,type:h,_innertext:r}=s.attributes,{draggableComponents:c}=o,d={"data-gjs-type":h||"default",...c&&!r?{draggable:!0}:{},...l?{"data-highlightable":1}:{},...a?{contenteditable:"false","data-gjs-textable":"true"}:{}};e.each(n.attributes,e=>t.push(e.nodeName)),t.forEach(t=>i.removeAttr(t));const g={...d,...s.getAttributes()};e.keys(g).forEach(t=>!1===g[t]&&delete g[t]),i.attr(g),this.updateStyle()},updateContent(){this.getChildrenContainer().innerHTML=this.model.get("content")},prevDef(t){t.preventDefault()},updateScript(){const{model:t,em:e}=this;t.get("script")&&e&&e.get("Canvas").getCanvasView().updateScript(this)},getChildrenContainer(){var t=this.el;return"function"==typeof this.getChildrenSelector?t=this.el.querySelector(this.getChildrenSelector()):this.getTemplate,t},getOffsetRect(){const t={},e=this.el;let s=0,i=0;const n=o=>{const{offsetParent:l}=o;l?(s+=l.offsetTop,i+=l.offsetLeft,n(l)):(t.top=e.offsetTop+s,t.left=e.offsetLeft+i,t.bottom=t.top+e.offsetHeight,t.right=t.left+e.offsetWidth)};return n(e),t},isInViewport({rect:t}={}){const{el:e}=this,s=e.ownerDocument,{body:i}=s,{frameElement:n}=s.defaultView,{top:o,left:l}=t||this.getOffsetRect(),a=this._getFrame().getOffsetRect();return o>=a.scrollTop&&l>=a.scrollLeft&&o<=a.scrollBottom&&l<=n.offsetWidth+i.scrollLeft},scrollIntoView(t={}){const e=this.getOffsetRect();if(!this.isInViewport({rect:e})||t.force){const{el:s}=this;"smooth"!==t.behavior?s.ownerDocument.defaultView.scrollTo(0,e.top):s.scrollIntoView({behavior:"smooth",block:"nearest",...t})}},reset(){const{el:t}=this;this.el="",this._ensureElement(),this._setData(),o.replaceWith(t,this.el),this.render()},_setData(){const{model:t}=this,e=t.components();this.$el.data({model:t,collection:e,view:this})},_getFrame(){return this.config.frameView},renderChildren(){this.updateContent();const t=this.getChildrenContainer(),e=new i({collection:this.model.get("components"),config:this.config,componentTypes:this.opts.componentTypes});e.render(t),this.childrenView=e;const s=Array.prototype.slice.call(e.el.childNodes);for(var n=0,o=s.length;n<o;n++)t.appendChild(s.shift())},renderAttributes(){this.updateAttributes(),this.updateClasses()},render(){return this.renderAttributes(),this.modelOpt.temporary?this:(this.renderChildren(),this.updateScript(),this.postRender(),this)},postRender(){const{em:t,model:e,modelOpt:s}=this;s.temporary||(this.onRender(this._clbObj()),t&&t.trigger("component:mount",e))},onRender(){}});return i.ComponentView=a,a});
//# sourceMappingURL=../../sourcemaps/dom_components/view/ComponentView.js.map
