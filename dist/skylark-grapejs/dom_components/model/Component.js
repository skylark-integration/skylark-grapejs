/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-underscore","../../utils/mixins","../../domain_abstract/model/Styleable","skylark-backbone","./Components","../../selector_manager/model/Selector","../../selector_manager/model/Selectors","../../trait_manager/model/Traits"],function(t,e,s,i,r,n,a,o,h){"use strict";const c=t=>t.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),l=r.Model.extend(i).extend({defaults:{tagName:"div",type:"",name:"",removable:!0,draggable:!0,droppable:!0,badgable:!0,stylable:!0,"stylable-require":"","style-signature":"",unstylable:"",highlightable:!0,copyable:!0,resizable:!1,editable:!1,layerable:!0,selectable:!0,hoverable:!0,void:!1,state:"",status:"",content:"",icon:"",style:"",classes:"",script:"","script-export":"",attributes:"",traits:["id","title"],propagate:"",dmode:"",toolbar:null},init(){},updated(t,e,s){},removed(){},initialize(s={},i={}){const r=i.em,n=this.parent(),a=n&&n.attributes;if(a&&a.propagate){let e={};const i=a.propagate;i.forEach(t=>e[t]=n.get(t)),e.propagate=i,e=t.mixin({},e,s),this.set(e)}const o=this.get("propagate");o&&this.set("propagate",e.isArray(o)?o:[o]),i&&i.config&&i.config.voidElements.indexOf(this.get("tagName"))>=0&&this.set("void",!0),i.em=r,this.opt=i,this.em=r,this.frame=i.frame,this.config=i.config||{},this.set("attributes",t.mixin({},this.defaults.attributes,this.get("attributes"))),this.ccid=l.createId(this),this.initClasses(),this.initTraits(),this.initComponents(),this.initToolbar(),this.listenTo(this,"change:script",this.scriptUpdated),this.listenTo(this,"change:tagName",this.tagUpdated),this.listenTo(this,"change:attributes",this.attrUpdated),this.listenTo(this,"change:attributes:id",this._idUpdated),this.set("status",""),this.views=[],["classes","traits","components"].forEach(t=>{const e=`add remove ${"components"!==t?"change":""}`;this.listenTo(this.get(t),e.trim(),(...e)=>this.emitUpdate(t,...e))}),i.temporary||(this.init(),r&&r.trigger("component:create",this))},is(t){return!(this.get("type")!=t)},props(){return this.attributes},index(){const{collection:t}=this;return t&&t.indexOf(this)},setDragMode(t){return this.set("dmode",t)},find(t){const e=[],s=this.view.$el.find(t);return s.each(t=>{const i=s.eq(t).data("model");i&&e.push(i)}),e},findType(t){const e=[],s=i=>i.forEach(i=>{i.is(t)&&e.push(i),s(i.components())});return s(this.components()),e},closest(t){const e=this.view.$el.closest(t);return e.length&&e.data("model")},tagUpdated(){const t=this.collection,e=t.indexOf(this);t.remove(this),t.add(this,{at:e})},replaceWith(t){const e=this.collection,s=e.indexOf(this);return e.remove(this),e.add(t,{at:s})},attrUpdated(t,i,r={}){const n=this.get("attributes"),a=n.class;a&&this.setClass(a),delete n.class;const o=n.style;o&&this.setStyle(o),delete n.style;const h={...this.previous("attributes")},c=s.shallowDiff(h,this.get("attributes"));e.keys(c).forEach(t=>this.trigger(`change:attributes:${t}`,this,c[t],r))},setAttributes(t,e={}){return this.set("attributes",{...t},e),this},addAttributes(t){const e={...this.getAttributes(),...t};return this.setAttributes(e),this},getStyle(){const t=this.em;if(t&&t.getConfig("avoidInlineStyle")){const e=t.get("state"),s=t.get("CssComposer").getIdRule(this.getId(),{state:e});if(this.rule=s,s)return s.getStyle()}return i.getStyle.call(this)},setStyle(t={},r={}){const n=this.em,{opt:a}=this;if(n&&n.getConfig("avoidInlineStyle")&&!a.temporary){const i=this.get("style")||{};t={...t=e.isString(t)?this.parseStyle(t):t,...i};const a=n.get("state"),o=n.get("CssComposer"),h=this.getStyle();this.rule=o.setIdRule(this.getId(),t,{...r,state:a});const c=s.shallowDiff(h,t);this.set("style",{},{silent:1}),e.keys(c).forEach(t=>this.trigger(`change:style:${t}`))}else t=i.setStyle.apply(this,arguments);return t},getAttributes(){const{em:t}=this,s=[],i={...this.get("attributes")},r=t&&t.get("SelectorManager"),n=this.getId();if(this.get("classes").forEach(t=>s.push(e.isString(t)?t:t.get("name"))),s.length&&(i.class=s.join(" ")),!e.has(i,"id")){let s;(t=>t&&t.getConfig("avoidInlineStyle"))(t)?s=r&&r.get(n,r.Selector.TYPE_ID):e.isEmpty(this.getStyle())||(s=1),s&&(i.id=this.getId())}return i},addClass(t){const e=this.em.get("SelectorManager").addClass(t);return this.get("classes").add(e)},setClass(t){return this.get("classes").reset(),this.addClass(t)},removeClass(t){const s=[];t=e.isArray(t)?t:[t];const i=this.get("classes"),r=a.TYPE_CLASS;return t.forEach(t=>{t.split(" ").forEach(t=>{const e=i.where({name:t,type:r})[0];e&&s.push(i.remove(e))})}),s},getClasses(){const t=this.getAttributes().class;return t?t.split(" "):[]},initClasses(){const t=[this,"change:classes",this.initClasses],s=this.get("classes")||[],i=e.isString(s)?s.split(" "):s;this.stopListening(...t);const r=this.normalizeClasses(i),n=new o([]);return this.set("classes",n),n.add(r),this.listenTo(...t),this},initComponents(){const t=[this,"change:components",this.initComponents];this.stopListening(...t);const s=new n(null,this.opt);s.parent=this;const i=this.get("components"),r=!this.opt.avoidChildren;return this.set("components",s),r&&s.add(e.isFunction(i)?i(this):i),this.listenTo(...t),this},initTraits(t){const{em:e}=this,s=[this,"change:traits",this.initTraits];this.stopListening(...s),this.loadTraits();const i={...this.get("attributes")},r=this.get("traits");return r.each(t=>{if(!t.get("changeProp")){const e=t.get("name"),s=t.getInitValue();e&&s&&(i[e]=s)}}),r.length&&this.set("attributes",i),this.listenTo(...s),t&&e&&e.trigger("component:toggled"),this},append(t,s={}){const i=this.components().add(t,s);return e.isArray(i)?i:[i]},components(t){const s=this.get("components");return e.isUndefined(t)?s:(s.reset(),t&&this.append(t))},parent(){const t=this.collection;return t&&t.parent},scriptUpdated(){this.set("scriptUpdated",1)},initToolbar(){const{em:t}=this,e=this,s=t&&t.getConfig("stylePrefix")||"";if(!e.get("toolbar")){var i=[];e.collection&&i.push({attributes:{class:"fa fa-arrow-up"},command:t=>t.runCommand("core:component-exit",{force:1})}),e.get("draggable")&&i.push({attributes:{class:`fa fa-arrows ${s}no-touch-actions`,draggable:!0},command:"tlb-move"}),e.get("copyable")&&i.push({attributes:{class:"fa fa-clone"},command:"tlb-clone"}),e.get("removable")&&i.push({attributes:{class:"fa fa-trash-o"},command:"tlb-delete"}),e.set("toolbar",i)}},loadTraits(t,s={}){if(t=t||this.get("traits"),!((t=e.isFunction(t)?t(this):t)instanceof h)){const e=new h([],this.opt);e.setTarget(this),t.length&&(t.forEach(t=>t.attributes&&delete t.attributes.value),e.add(t)),this.set("traits",e,s)}return this},getTrait(t){return this.get("traits").filter(e=>e.get("id")===t||e.get("name")===t)[0]},updateTrait(t,e){const{em:s}=this,i=this.getTrait(t);return i&&i.set(e),s&&s.trigger("component:toggled"),this},getTraitIndex(t){const e=this.getTrait(t);return e?this.get("traits").indexOf(e):e},removeTrait(t){const{em:s}=this,i=(e.isArray(t)?t:[t]).map(t=>this.getTrait(t)),r=this.get("traits").remove(i);return s&&s.trigger("component:toggled"),r},addTrait(t,e={}){const{em:s}=this,i=this.get("traits").add(t,e);return s&&s.trigger("component:toggled"),i},normalizeClasses(t){var e=[];const s=this.em;if(s){var i=s.get("SelectorManager");if(i)return t.forEach(t=>{var s="";s="string"==typeof t?t:t.name;var r=i.add(s);e.push(r)}),e}},clone(){const t=this.em,s=this.getStyle(),i={...this.attributes},r={...this.opt};i.attributes={...i.attributes},delete i.attributes.id,i.components=[],i.classes=[],i.traits=[],this.get("components").each((t,e)=>{i.components[e]=t.clone()}),this.get("traits").each((t,e)=>{i.traits[e]=t.clone()}),this.get("classes").each((t,e)=>{i.classes[e]=t.get("name")}),i.status="",i.view="",r.collection=null,t&&t.getConfig("avoidInlineStyle")&&!e.isEmpty(s)&&(i.style=s);const n=new this.constructor(i,r);return t&&t.trigger("component:clone",n),this.trigger("component:clone",n),n},getName(){const{em:t}=this,{type:e,tagName:i}=this.attributes,r=this.get("name"),n="div"==i,a=e||(n?"box":i),o=!e&&i&&!n&&i,h="domComponents.names.",c=r&&t&&t.t(`${h}${r}`),l=o&&t&&t.t(`${h}${o}`),g=t&&(t.t(`${h}${e}`)||t.t(`${h}${i}`));return this.get("custom-name")||c||r||l||s.capitalize(o)||g||s.capitalize(a)},getIcon(){let t=this.get("icon");return t?t+" ":""},toHTML(t={}){const s=this,i=[],r=t.tag||s.get("tagName"),n=s.get("void"),a=t.attributes;let o=this.getAttrToHTML();delete t.tag,a&&(e.isFunction(a)?o=a(s,o)||{}:e.isObject(a)&&(o=a));for(let t in o){const s=o[t],r=e.isString(s)?s.replace(/"/g,"&quot;"):s;e.isUndefined(r)||(e.isBoolean(r)?r&&i.push(t):i.push(`${t}="${r}"`))}let h=`<${r}${i.length?` ${i.join(" ")}`:""}${n?"/":""}>${s.get("content")}`;return s.get("components").each(e=>h+=e.toHTML(t)),!n&&(h+=`</${r}>`),h},getAttrToHTML(){var t=this.getAttributes();return delete t.style,t},toJSON(...t){const s=r.Model.prototype.toJSON.apply(this,t);if(s.attributes=this.getAttributes(),delete s.attributes.class,delete s.toolbar,delete s.traits,this.em.getConfig("avoidDefaults")){const t=e.result(this,"defaults");e.forEach(t,(t,e)=>{-1===["type","content"].indexOf(e)&&s[e]===t&&delete s[e]}),e.isEmpty(s.type)&&delete s.type,e.forEach(["attributes","style"],i=>{e.isEmpty(t[i])&&e.isEmpty(s[i])&&delete s[i]}),e.forEach(["classes","components"],i=>{e.isEmpty(t[i])&&!s[i].length&&delete s[i]})}return s},getId(){return(this.get("attributes")||{}).id||this.ccid||this.cid},setId(t,e){const s={...this.get("attributes")};return s.id=t,this.set("attributes",s,e),this},getEl(t){const e=this.getView(t);return e&&e.el},getView(t){let{view:e,views:s}=this;return t&&(e=s.filter(e=>e._getFrame()===t.view)[0]),e},getCurrentView(){const t=(this.em.get("currentFrame")||{}).model;return this.getView(t)},getScriptString(t){var s=t||this.get("script");if(!s)return s;if("function"==typeof s){var i=s.toString().trim();s=(i=i.replace(/^function[\s\w]*\(\)\s?\{/,"").replace(/\}$/,"")).trim()}var r=this.em.getConfig(),n=c(r.tagVarStart||"{[ "),a=c(r.tagVarEnd||" ]}"),o=new RegExp(`${n}([\\w\\d-]*)${a}`,"g");return s=s.replace(o,(t,s)=>{this.scriptUpdated();const i=this.attributes[s]||"";return e.isArray(i)||"object"==typeof i?JSON.stringify(i):i})},emitUpdate(t,...e){const s=this.em,i="component:update"+(t?`:${t}`:"");t&&this.updated(t,t&&this.get(t),t&&this.previous(t),...e),this.trigger(i,...e),s&&s.trigger(i,this,...e)},onAll(t){return e.isFunction(t)&&(t(this),this.components().forEach(e=>e.onAll(t))),this},remove(){const t=this.collection;return t&&t.remove(this)},resetId(t={}){const{em:e}=this,s=this.getId();if(!s)return;const i=l.createId(this);this.setId(i);const r=e&&e.get("CssComposer").getIdRule(s),n=r&&r.get("selectors").at(0);return n&&n.set("name",i),this},_getStyleRule({id:t}={}){const{em:e}=this,s=t||this.getId();return e&&e.get("CssComposer").getIdRule(s)},_getStyleSelector(t){const e=this._getStyleRule(t);return e&&e.get("selectors").at(0)},_idUpdated(t,e,s={}){if(s.idUpdate)return;const{ccid:i}=this,{id:r}=this.get("attributes")||{},n=(this.previous("attributes")||{}).id||i,a=l.getList(this);if(a[r])return this.setId(n,{idUpdate:1});delete a[n],a[r]=this,this.ccid=r;const o=this._getStyleSelector({id:n});o&&o.set({name:r,label:r})}},{isComponent:t=>({tagName:t.tagName?t.tagName.toLowerCase():""}),createId(t){const e=l.getList(t);let s,{id:i}=t.get("attributes");return i?(s=l.getIncrementId(i,e),t.setId(s)):s=l.getNewId(e),e[s]=t,s},getNewId(t){const e=Object.keys(t).length.toString().length+2;let s=`i${(Math.random()+1.1).toString(36).slice(-e)}`;for(;t[s];)s=l.getNewId(t);return s},getIncrementId(t,e){let s=1,i=t;for(;e[i];)i=`${t}-${++s}`;return i},getList(t){const e=t.opt&&t.opt.domc;return e?e.componentsById:{}},checkId(t,s=[],i={}){(e.isArray(t)?t:[t]).forEach(t=>{const{attributes:r={},components:n}=t,{id:a}=r;if(a&&i[a]){const t=l.getIncrementId(a,i);r.id=t,e.isArray(s)&&s.forEach(e=>{const{selectors:s}=e;s.forEach((e,i)=>{e===`#${a}`&&(s[i]=`#${t}`)})})}n&&l.checkId(n,s,i)})}});return l.eventDrag="component:drag",n.Component=l,l});
//# sourceMappingURL=../../sourcemaps/dom_components/model/Component.js.map
