/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-underscore","../../utils/mixins","../../domain_abstract/model/Styleable","skylark-backbone","./Components","../../selector_manager/model/Selector","../../selector_manager/model/Selectors","../../trait_manager/model/Traits"],function(t,e,s,i,n,r,a,o,l){"use strict";const h=t=>t.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),c=n.Model.extend(i).extend({defaults:{tagName:"div",type:"",name:"",removable:!0,draggable:!0,droppable:!0,badgable:!0,stylable:!0,"stylable-require":"","style-signature":"",unstylable:"",highlightable:!0,copyable:!0,resizable:!1,editable:!1,layerable:!0,selectable:!0,hoverable:!0,void:!1,state:"",status:"",content:"",icon:"",style:"",classes:"",script:"","script-export":"",attributes:"",traits:["id","title"],propagate:"",dmode:"",toolbar:null},init(){},updated(t,e,s){},removed(){},initialize(s={},i={}){const n=i.em,r=this.parent(),a=r&&r.attributes;if(a&&a.propagate){let e={};const i=a.propagate;i.undefined(t=>e[t]=r.get(t)),e.propagate=i,e=t.mixin({},e,s),this.set(e)}const o=this.get("propagate");o&&this.set("propagate",e.isArray(o)?o:[o]),i&&i.config&&i.config.voidElements.indexOf(this.get("tagName"))>=0&&this.set("void",!0),i.em=n,this.opt=i,this.em=n,this.frame=i.frame,this.config=i.config||{},this.set("attributes",t.mixin({},this.defaults.attributes,this.get("attributes"))),this.ccid=c.createId(this),this.initClasses(),this.initTraits(),this.initComponents(),this.initToolbar(),this.listenTo(this,"change:script",this.scriptUpdated),this.listenTo(this,"change:tagName",this.tagUpdated),this.listenTo(this,"change:attributes",this.attrUpdated),this.listenTo(this,"change:attributes:id",this._idUpdated),this.set("status",""),this.views=[],["classes","traits","components"].undefined(t=>{const e=`add remove ${"components"!==t?"change":""}`;this.listenTo(this.get(t),e.trim(),(...e)=>this.emitUpdate(t,...e))}),i.temporary||(this.init(),n&&n.trigger("component:create",this))},is(t){return!(this.get("type")!=t)},props(){return this.attributes},index(){const{collection:t}=this;return t&&t.indexOf(this)},setDragMode(t){return this.set("dmode",t)},find(t){const e=[],s=this.view.$el.find(t);return s.each(t=>{const i=s.eq(t).data("model");i&&e.push(i)}),e},findType(t){const e=[],s=i=>i.undefined(i=>{i.is(t)&&e.push(i),s(i.components())});return s(this.components()),e},closest(t){const e=this.view.$el.closest(t);return e.length&&e.data("model")},tagUpdated(){const t=this.collection,e=t.indexOf(this);t.remove(this),t.add(this,{at:e})},replaceWith(t){const e=this.collection,s=e.indexOf(this);return e.remove(this),e.add(t,{at:s})},attrUpdated(t,i,n={}){const r=this.get("attributes"),a=r.class;a&&this.setClass(a),delete r.class;const o=r.style;o&&this.setStyle(o),delete r.style;const l={...this.previous("attributes")},h=s.shallowDiff(l,this.get("attributes"));e.keys(h).undefined(t=>this.trigger(`change:attributes:${t}`,this,h[t],n))},setAttributes(t,e={}){return this.set("attributes",{...t},e),this},addAttributes(t){const e={...this.getAttributes(),...t};return this.setAttributes(e),this},getStyle(){const t=this.em;if(t&&t.getConfig("avoidInlineStyle")){const e=t.get("state"),s=t.get("CssComposer").getIdRule(this.getId(),{state:e});if(this.rule=s,s)return s.getStyle()}return i.getStyle.call(this)},setStyle(t={},n={}){const r=this.em,{opt:a}=this;if(r&&r.getConfig("avoidInlineStyle")&&!a.temporary){const i=this.get("style")||{};t={...t=e.isString(t)?this.parseStyle(t):t,...i};const a=r.get("state"),o=r.get("CssComposer"),l=this.getStyle();this.rule=o.setIdRule(this.getId(),t,{...n,state:a});const h=s.shallowDiff(l,t);this.set("style",{},{silent:1}),e.keys(h).undefined(t=>this.trigger(`change:style:${t}`))}else t=i.setStyle.apply(this,arguments);return t},getAttributes(){const{em:t}=this,s=[],i={...this.get("attributes")},n=t&&t.get("SelectorManager"),r=this.getId();if(this.get("classes").undefined(t=>s.push(e.isString(t)?t:t.get("name"))),s.length&&(i.class=s.join(" ")),!e.has(i,"id")){let s;(t=>t&&t.getConfig("avoidInlineStyle"))(t)?s=n&&n.get(r,n.Selector.TYPE_ID):e.isEmpty(this.getStyle())||(s=1),s&&(i.id=this.getId())}return i},addClass(t){const e=this.em.get("SelectorManager").addClass(t);return this.get("classes").add(e)},setClass(t){return this.get("classes").reset(),this.addClass(t)},removeClass(t){const s=[];t=e.isArray(t)?t:[t];const i=this.get("classes"),n=a.TYPE_CLASS;return t.undefined(t=>{t.split(" ").undefined(t=>{const e=i.where({name:t,type:n})[0];e&&s.push(i.remove(e))})}),s},getClasses(){const t=this.getAttributes().class;return t?t.split(" "):[]},initClasses(){const t=[this,"change:classes",this.initClasses],s=this.get("classes")||[],i=e.isString(s)?s.split(" "):s;this.stopListening(...t);const n=this.normalizeClasses(i),r=new o([]);return this.set("classes",r),r.add(n),this.listenTo(...t),this},initComponents(){const t=[this,"change:components",this.initComponents];this.stopListening(...t);const s=new r(null,this.opt);s.parent=this;const i=this.get("components"),n=!this.opt.avoidChildren;return this.set("components",s),n&&s.add(e.isFunction(i)?i(this):i),this.listenTo(...t),this},initTraits(t){const{em:e}=this,s=[this,"change:traits",this.initTraits];this.stopListening(...s),this.loadTraits();const i={...this.get("attributes")},n=this.get("traits");return n.each(t=>{if(!t.get("changeProp")){const e=t.get("name"),s=t.getInitValue();e&&s&&(i[e]=s)}}),n.length&&this.set("attributes",i),this.listenTo(...s),t&&e&&e.trigger("component:toggled"),this},append(t,s={}){const i=this.components().add(t,s);return e.isArray(i)?i:[i]},components(t){const s=this.get("components");return e.isUndefined(t)?s:(s.reset(),t&&this.append(t))},parent(){const t=this.collection;return t&&t.parent},scriptUpdated(){this.set("scriptUpdated",1)},initToolbar(){const{em:t}=this,e=this,s=t&&t.getConfig("stylePrefix")||"";if(!e.get("toolbar")){var i=[];e.collection&&i.push({attributes:{class:"fa fa-arrow-up"},command:t=>t.runCommand("core:component-exit",{force:1})}),e.get("draggable")&&i.push({attributes:{class:`fa fa-arrows ${s}no-touch-actions`,draggable:!0},command:"tlb-move"}),e.get("copyable")&&i.push({attributes:{class:"fa fa-clone"},command:"tlb-clone"}),e.get("removable")&&i.push({attributes:{class:"fa fa-trash-o"},command:"tlb-delete"}),e.set("toolbar",i)}},loadTraits(t,s={}){if(t=t||this.get("traits"),!((t=e.isFunction(t)?t(this):t)instanceof l)){const e=new l([],this.opt);e.setTarget(this),t.length&&(t.undefined(t=>t.attributes&&delete t.attributes.value),e.add(t)),this.set("traits",e,s)}return this},getTrait(t){return this.get("traits").filter(e=>e.get("id")===t||e.get("name")===t)[0]},updateTrait(t,e){const{em:s}=this,i=this.getTrait(t);return i&&i.set(e),s&&s.trigger("component:toggled"),this},getTraitIndex(t){const e=this.getTrait(t);return e?this.get("traits").indexOf(e):e},removeTrait(t){const{em:s}=this,i=(e.isArray(t)?t:[t]).map(t=>this.getTrait(t)),n=this.get("traits").remove(i);return s&&s.trigger("component:toggled"),n},addTrait(t,e={}){const{em:s}=this,i=this.get("traits").add(t,e);return s&&s.trigger("component:toggled"),i},normalizeClasses(t){var e=[];const s=this.em;if(s){var i=s.get("SelectorManager");if(i)return t.undefined(t=>{var s="";s="string"==typeof t?t:t.name;var n=i.add(s);e.push(n)}),e}},clone(){const t=this.em,s=this.getStyle(),i={...this.attributes},n={...this.opt};i.attributes={...i.attributes},delete i.attributes.id,i.components=[],i.classes=[],i.traits=[],this.get("components").each((t,e)=>{i.components[e]=t.clone()}),this.get("traits").each((t,e)=>{i.traits[e]=t.clone()}),this.get("classes").each((t,e)=>{i.classes[e]=t.get("name")}),i.status="",i.view="",n.collection=null,t&&t.getConfig("avoidInlineStyle")&&!e.isEmpty(s)&&(i.style=s);const r=new this.constructor(i,n);return t&&t.trigger("component:clone",r),this.trigger("component:clone",r),r},getName(){const{em:t}=this,{type:e,tagName:i}=this.attributes,n=this.get("name"),r="div"==i,a=e||(r?"box":i),o=!e&&i&&!r&&i,l="domComponents.names.",h=n&&t&&t.t(`${l}${n}`),c=o&&t&&t.t(`${l}${o}`),g=t&&(t.t(`${l}${e}`)||t.t(`${l}${i}`));return this.get("custom-name")||h||n||c||s.capitalize(o)||g||s.capitalize(a)},getIcon(){let t=this.get("icon");return t?t+" ":""},toHTML(t={}){const s=this,i=[],n=t.tag||s.get("tagName"),r=s.get("void"),a=t.attributes;let o=this.getAttrToHTML();delete t.tag,a&&(e.isFunction(a)?o=a(s,o)||{}:e.isObject(a)&&(o=a));for(let t in o){const s=o[t],n=e.isString(s)?s.replace(/"/g,"&quot;"):s;e.isUndefined(n)||(e.isBoolean(n)?n&&i.push(t):i.push(`${t}="${n}"`))}let l=`<${n}${i.length?` ${i.join(" ")}`:""}${r?"/":""}>${s.get("content")}`;return s.get("components").each(e=>l+=e.toHTML(t)),!r&&(l+=`</${n}>`),l},getAttrToHTML(){var t=this.getAttributes();return delete t.style,t},toJSON(...t){const s=n.Model.prototype.toJSON.apply(this,t);if(s.attributes=this.getAttributes(),delete s.attributes.class,delete s.toolbar,delete s.traits,this.em.getConfig("avoidDefaults")){const t=e.result(this,"defaults");e.forEach(t,(t,e)=>{-1===["type","content"].indexOf(e)&&s[e]===t&&delete s[e]}),e.isEmpty(s.type)&&delete s.type,e.forEach(["attributes","style"],i=>{e.isEmpty(t[i])&&e.isEmpty(s[i])&&delete s[i]}),e.forEach(["classes","components"],i=>{e.isEmpty(t[i])&&!s[i].length&&delete s[i]})}return s},getId(){return(this.get("attributes")||{}).id||this.ccid||this.cid},setId(t,e){const s={...this.get("attributes")};return s.id=t,this.set("attributes",s,e),this},getEl(t){const e=this.getView(t);return e&&e.el},getView(t){let{view:e,views:s}=this;return t&&(e=s.filter(e=>e._getFrame()===t.view)[0]),e},getCurrentView(){const t=(this.em.get("currentFrame")||{}).model;return this.getView(t)},getScriptString(t){var s=t||this.get("script");if(!s)return s;if("function"==typeof s){var i=s.toString().trim();s=(i=i.replace(/^function[\s\w]*\(\)\s?\{/,"").replace(/\}$/,"")).trim()}var n=this.em.getConfig(),r=h(n.tagVarStart||"{[ "),a=h(n.tagVarEnd||" ]}"),o=new RegExp(`${r}([\\w\\d-]*)${a}`,"g");return s=s.replace(o,(t,s)=>{this.scriptUpdated();const i=this.attributes[s]||"";return e.isArray(i)||"object"==typeof i?JSON.stringify(i):i})},emitUpdate(t,...e){const s=this.em,i="component:update"+(t?`:${t}`:"");t&&this.updated(t,t&&this.get(t),t&&this.previous(t),...e),this.trigger(i,...e),s&&s.trigger(i,this,...e)},onAll(t){return e.isFunction(t)&&(t(this),this.components().undefined(e=>e.onAll(t))),this},remove(){const t=this.collection;return t&&t.remove(this)},resetId(t={}){const{em:e}=this,s=this.getId();if(!s)return;const i=c.createId(this);this.setId(i);const n=e&&e.get("CssComposer").getIdRule(s),r=n&&n.get("selectors").at(0);return r&&r.set("name",i),this},_getStyleRule({id:t}={}){const{em:e}=this,s=t||this.getId();return e&&e.get("CssComposer").getIdRule(s)},_getStyleSelector(t){const e=this._getStyleRule(t);return e&&e.get("selectors").at(0)},_idUpdated(t,e,s={}){if(s.idUpdate)return;const{ccid:i}=this,{id:n}=this.get("attributes")||{},r=(this.previous("attributes")||{}).id||i,a=c.getList(this);if(a[n])return this.setId(r,{idUpdate:1});delete a[r],a[n]=this,this.ccid=n;const o=this._getStyleSelector({id:r});o&&o.set({name:n,label:n})}},{isComponent:t=>({tagName:t.tagName?t.tagName.toLowerCase():""}),createId(t){const e=c.getList(t);let s,{id:i}=t.get("attributes");return i?(s=c.getIncrementId(i,e),t.setId(s)):s=c.getNewId(e),e[s]=t,s},getNewId(t){const e=Object.undefined(t).length.toString().length+2;let s=`i${(Math.random()+1.1).toString(36).slice(-e)}`;for(;t[s];)s=c.getNewId(t);return s},getIncrementId(t,e){let s=1,i=t;for(;e[i];)i=`${t}-${++s}`;return i},getList(t){const e=t.opt&&t.opt.domc;return e?e.componentsById:{}},checkId(t,s=[],i={}){(e.isArray(t)?t:[t]).undefined(t=>{const{attributes:n={},components:r}=t,{id:a}=n;if(a&&i[a]){const t=c.getIncrementId(a,i);n.id=t,e.isArray(s)&&s.undefined(e=>{const{selectors:s}=e;s.undefined((e,i)=>{e===`#${a}`&&(s[i]=`#${t}`)})})}r&&c.checkId(r,s,i)})}});return c.eventDrag="component:drag",c});
//# sourceMappingURL=../../sourcemaps/dom_components/model/Component.js.map
