/**
 * skylark-grapejs - A version of garpejs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-grapejs/
 * @license MIT
 */
define(["skylark-langx","skylark-underscore","skylark-jquery","skylark-backbone","../../utils/extender","../../utils/mixins","../../utils/index","../../i18n/index","../../keymaps/index","../../undo_manager/index","../../storage_manager/index","../../device_manager/index","../../parser/index","../../selector_manager/index","../../style_manager/index","../../modal_dialog/index","../../code_manager/index","../../panels/index","../../rich_text_editor/index","../../asset_manager/index","../../css_composer/index","../../trait_manager/index","../../dom_components/index","../../navigator/index","../../canvas/index","../../commands/index","../../block_manager/index"],function(e,t,s,o,n,i,r,a,g,d,l,h,c,m,u,p,f,C,v,x,y,S,M,b,w,k,E){"use strict";o.$=s;const A=[r,a,g,d,l,h,c,m,u,p,f,C,v,x,y,S,M,b,w,k,E],{Collection:_}=o;let L,D;n({Backbone:o,$:o.$});const $={debug:console.log,info:console.info,warning:console.warn,error:console.error};return o.Model.extend({defaults:()=>({editing:0,selected:new _,clipboard:null,dmode:0,componentHovered:null,previousModel:null,changesCount:0,storables:[],modules:[],toLoad:[],opened:{},device:""}),initialize(e={}){this.config=e,this.set("Config",e),this.set("modules",[]),this.set("toLoad",[]),this.set("storables",[]),this.set("dmode",e.dragMode);const s=e.el,o=e.log,n=!0===o?t.keys($):t.isArray(o)?o:[];t.bindAll(this,"initBaseColorPicker"),s&&e.fromElement&&(this.config.components=s.innerHTML),this.attrsOrig=s?t.toArray(s.attributes).reduce((e,t)=>(e[t.nodeName]=t.nodeValue,e),{}):"",A.forEach(e=>this.loadModule(e)),this.on("change:componentHovered",this.componentHovered,this),this.on("change:changesCount",this.updateChanges,this),n.forEach(e=>this.listenLog(e)),[{from:"change:selectedComponent",to:"component:toggled"}].forEach(e=>{const t=e.from,s=e.to;this.listenTo(this,t,(...e)=>{this.trigger(s,...e),this.logWarning(`The event '${t}' is deprecated, replace it with '${s}'`)})})},getContainer(){return this.config.el},listenLog(e){this.listenTo(this,`log:${e}`,$[e])},getConfig(e){const s=this.config;return t.isUndefined(e)?s:s[e]},loadOnStart(e=null){const t=this.get("StorageManager");this.get("toLoad").forEach(module=>{module.onLoad()});const s=()=>{this.get("modules").forEach(module=>module.postLoad&&module.postLoad(this)),e&&e()};t&&t.canAutoload()?this.load(s):s()},updateChanges(){const e=this.get("StorageManager"),t=this.get("changesCount");D&&clearTimeout(D),D=setTimeout(()=>this.trigger("update")),this.config.noticeOnUnload&&(window.onbeforeunload=t?e=>1:null),e.isAutosave()&&t>=e.getStepsBeforeSave()&&this.store()},loadModule(e){const{config:s}=this,o=new(e.default||e),n=o.name.charAt(0).toLowerCase()+o.name.slice(1),i=t.isUndefined(s[n])?s[o.name]:s[n],r=i||{},a=this.get("StorageManager");if(r.pStylePrefix=s.pStylePrefix||"",t.isUndefined(i)||i||(r._disable=1),o.storageKey&&o.store&&o.load&&a){r.stm=a;const e="domComponents"==n?"unshift":"push";this.get("storables")[e](o)}return r.em=this,o.init(r),!o.private&&this.set(o.name,o),o.onLoad&&this.get("toLoad").push(o),this.get("modules").push(o),this},init(e){this.set("Editor",e)},getEditor(){return this.get("Editor")},handleUpdates(e,t,s={}){s.temporary||(L&&clearInterval(L),L=setTimeout(()=>{s.avoidStore||this.set("changesCount",this.get("changesCount")+1,s)},0))},componentHovered(e,t,s){const o=this.previous("componentHovered");o&&this.trigger("component:unhovered",o,s),t&&this.trigger("component:hovered",t,s)},getSelected(){return this.get("selected").last()},getSelectedAll(){return this.get("selected").models},setSelected(e,o={}){const n=t.isArray(e),r=n?e:[e],a=this.get("selected");let g;n&&this.removeSelected(a.filter(e=>!t.contains(r,e))),r.forEach(e=>{const t=i.getModel(e,s);t&&!t.get("selectable")||(!n&&this.removeSelected(a.filter(e=>e!==t)),this.addSelected(t,o),g=t)})},addSelected(e,o={}){const n=i.getModel(e,s);(t.isArray(n)?n:[n]).forEach(e=>{if(e&&!e.get("selectable"))return;const t=this.get("selected");o.forceChange&&t.remove(e,o),t.push(e,o)})},removeSelected(e,t={}){this.get("selected").remove(i.getModel(e,s),t)},toggleSelected(e,o={}){const n=i.getModel(e,s);(t.isArray(n)?n:[n]).forEach(e=>{this.get("selected").undefined(e)?this.removeSelected(e,o):this.addSelected(e,o)})},setHovered(e,t={}){const o=i.getModel(e,s);o&&!o.get("hoverable")||(t.forceChange&&this.set("componentHovered",""),this.set("componentHovered",o,t))},getHovered(){return this.get("componentHovered")},setComponents(e){return this.get("DomComponents").setComponents(e)},getComponents(){var e=this.get("DomComponents"),t=this.get("CodeManager");if(e&&t){var s=e.getComponents();return t.getCode(s,"json")}},setStyle(e){for(var t=this.get("CssComposer").getAll(),s=0,o=t.length;s<o;s++)t.pop();return t.add(e),this},getStyle(){return this.get("CssComposer").getAll()},setState(e){return this.set("state",e),this},getState(){return this.get("state")},getHtml(){const e=this.config,t=e.exportWrapper,s=e.wrapperIsBody,o=e.jsInHtml?this.getJs():"";var n=this.get("DomComponents").getComponent(),i=this.get("CodeManager").getCode(n,"html",{exportWrapper:t,wrapperIsBody:s});return i+=o?`<script>${o}<\/script>`:""},getCss(e={}){const s=this.config,o=s.wrapperIsBody,n=e.avoidProtected,i=t.isUndefined(e.keepUnusedStyles)?s.keepUnusedStyles:e.keepUnusedStyles,r=this.get("CssComposer"),a=this.get("DomComponents").getComponent();return(n?"":s.protectedCss)+this.get("CodeManager").getCode(a,"css",{cssc:r,wrapperIsBody:o,keepUnusedStyles:i})},getJs(){var e=this.get("DomComponents").getWrapper();return this.get("CodeManager").getCode(e,"js").trim()},store(e){var t=this.get("StorageManager"),s={};if(t)return this.get("storables").forEach(e=>{var t=e.store(1);for(var o in t)s[o]=t[o]}),t.store(s,t=>{e&&e(t),this.set("changesCount",0),this.trigger("storage:store",s)}),s},load(e=null){this.getCacheLoad(1,t=>{this.get("storables").forEach(module=>module.load(t)),e&&e(t)})},getCacheLoad(e,s){if(this.cacheLoad&&!e)return this.cacheLoad;const o=this.get("StorageManager"),n=[];if(!o)return{};this.get("storables").forEach(e=>{let s=e.storageKey;s=t.isFunction(s)?s():s,(t.isArray(s)?s:[s]).forEach(e=>n.push(e))}),o.load(n,e=>{this.cacheLoad=e,s&&s(e),setTimeout(()=>this.trigger("storage:load",e))})},getDeviceModel(){var e=this.get("device");return this.get("DeviceManager").get(e)},runDefault(e={}){var t=this.get("Commands").get(this.config.defaultCommand);t&&!this.defaultRunning&&(t.stop(this,this,e),t.run(this,this,e),this.defaultRunning=1)},stopDefault(e={}){var t=this.get("Commands").get(this.config.defaultCommand);t&&(t.stop(this,this,e),this.defaultRunning=0)},refreshCanvas(){this.set("canvasOffset",null),this.set("canvasOffset",this.get("Canvas").getOffset())},clearSelection(e){(e||window).getSelection().removeAllRanges()},getCurrentMedia(){const e=this.config,t=this.getDeviceModel(),s=e.mediaCondition,o=e.devicePreviewMode,n=t&&t.get("widthMedia");return t&&n&&!o?`(${s}: ${n})`:""},getWrapper(){return this.get("DomComponents").getWrapper()},setCurrentFrame(e){return this.set("currentFrame",e)},getCurrentFrame(){return this.get("currentFrame")},getCurrentFrameModel(){return(this.getCurrentFrame()||{}).model},getDirtyCount(){return this.get("changesCount")},getZoomDecimal(){return this.get("Canvas").getZoomDecimal()},getZoomMultiplier(){return this.get("Canvas").getZoomMultiplier()},setDragMode(e){return this.set("dmode",e)},t(...e){return this.get("I18n").t(...e)},inAbsoluteMode(){return"absolute"===this.get("dmode")},destroyAll(){const{DomComponents:e,CssComposer:t,UndoManager:o,Panels:n,Canvas:i,Keymaps:r,RichTextEditor:a}=this.attributes;e.clear(),t.clear(),o.clear().removeAll(),n.getPanels().reset(),i.getCanvasView().remove(),r.removeAll(),a.destroy(),this.view.remove(),this.stopListening(),s(this.config.el).empty().attr(this.attrsOrig)},setEditing(e){return this.set("editing",e),this},isEditing(){return!!this.get("editing")},log(e,t={}){const{ns:s,level:o="debug"}=t;if(this.trigger("log",e,t),o&&this.trigger(`log:${o}`,e,t),s){const n=`log-${s}`;this.trigger(n,e,t),o&&this.trigger(`${n}:${o}`,e,t)}},logInfo(t,s){this.log(t,e.mixin({},s,{evel:"info"}))},logWarning(t,s){this.log(t,e.mixin({},s,{evel:"warning"}))},logError(t,s){this.log(t,e.mixin({},s,{evel:"error"}))},initBaseColorPicker(t,o={}){const n=this.getConfig(),{colorPicker:i={}}=n,r=n.el,a=n.stylePrefix;return s(t).spectrum(e.mixin({containerClassName:`${a}one-bg ${a}two-color`,appendTo:r||"body",maxSelectionSize:8,showPalette:!0,palette:[],showAlpha:!0,chooseText:"Ok",cancelText:"тип"},o,i))},data(e,s,o){if(e["_gjs-data"]||(e["_gjs-data"]={}),t.isUndefined(o))return e["_gjs-data"][s];e["_gjs-data"][s]=o}})});
//# sourceMappingURL=../../sourcemaps/editor/model/Editor.js.map
